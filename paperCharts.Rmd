---
title: "Paper charts"
output:
  html_document:
    theme: paper
    toc: true
    toc_float:
      collapsed: false
---

<style>
.main-container {
  max-width: 95% !important;
}
.toc-content {
  padding-left: 0px !important;
}
.svg-container {
  margin: auto !important;
}
</style>


<!-- Setting default chunk options -->
```{r chunkOptions, echo=FALSE, include = FALSE}
#knitr::opts_chunk$set(echo = TRUE)
# setting global R chunk options (https://yihui.name/knitr/options/#chunk_options)
  knitr::opts_chunk$set(dev='svglite', # svg, png,...
                        fig.ext = ".svg",
                        #fig.asp = .8 # default aspect ratio
                        fig.width = 12,
                        fig.height = 6,
                        dpi=100
                        )
```  


```{r loading_packages, echo=FALSE, include = FALSE}

  #Loading required packages
  packagesList <- c("reticulate", "tidyr", "dplyr", "quitte", "openxlsx", "piamInterfaces", "ggplot2", "grid", "gridExtra", "ggh4x", "ggrepel")
  packages <- suppressWarnings(suppressMessages(lapply(packagesList, function(x){ if(!require(x, character.only = T, quietly = T)){ install.packages(x); return(paste0("installed missing package: ", x)) } else paste0("required package is installed: ", x) } )))

  #use_python("C:/Users/robertp/AppData/Local/Programs/Python/Python313")
```


<!-- ## download and prepare data -->

```{r load_data, echo=FALSE, include = FALSE}

downloadData <- FALSE

# define models groups
modelsFullSystem   <- c("IMAGE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH")
modelsElecall      <- c("IMAGE","LIMES", "MEESA","OSeMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH")

# select data file
dataFolder <- sort(list.dirs(path = "./data", full.names = TRUE, recursive = FALSE), decreasing = T)[1]
time <- basename(dataFolder)
outFolder <- paste0("./output/", time)
dataRDSFile <- paste0("./data/", time, "/WP1_", time, ".rds")
if(!(downloadData) & (file.exists(dataRDSFile))){
  df <- readRDS(dataRDSFile)
  histRDS <- paste0("./data/", time, "/WP1_", time, "_hist.rds")
  histData <- readRDS(histRDS)
} else {
  source("./prepare_data.R")
  dataFolder <- sort(list.dirs(path = "./data", full.names = TRUE, recursive = FALSE), decreasing = T)[1]
  time <- basename(dataFolder)
  dataRDS <- paste0("./data/", time, "/WP1_", time, ".rds")
  saveRDS(df,dataRDSFile)
  histRDS <- paste0("./data/", time, "/WP1_", time, "_hist.rds")
  histData <- histOrigN
  saveRDS(histData, histRDS)
}

```


```{r create_charts, echo=FALSE, include=FALSE}

  # creating charts
  g <- NULL

  # output folder
  dir.create(paste0("./output/", time, "/svg"), recursive = TRUE, showWarnings = FALSE)
  dir.create(paste0("./output/", time, "/png"), recursive = TRUE, showWarnings = FALSE)

``` 


```{r aesthetics, echo=FALSE, include=FALSE}

color <- c(
  #model
  "Historical" = "black",
  "mean" = "#c0c0c0",
  "median" = "#555555",
  "IMAGE" = "#00ffff",
  "Euro-Calliope" = "#84eab3",
  "MESSAGE" = "#800080",
  "PRIMES" = "#0000ff",
  "PROMETHEUS" = "#ffd900",
  "REMIND" = "#ff6347",
  "TIAM-ECN" = "#4682b4",
  "TIAM-ECN 1.2" = "#000000",
  "WITCH" = "#228b22",
  "LIMES" = "#ffaf47",
  "MEESA" = "#ff00ff",
  "OSeMBE" = "#a52a2a"
)

modelLinetype <- c(
  "Historical" = "solid",
  "mean" = "42", # dashed, 4 points on, one off
  "median" = "solid",
  "IMAGE" =       "solid" ,
  "Euro-Calliope" = "solid", 
  "MESSAGE" =    "solid",
  "PRIMES" =     "solid",
  "PROMETHEUS" = "solid",
  "REMIND" =     "solid",
  "TIAM-ECN" =   "solid",
  "TIAM-ECN 1.2" = "solid",
  "WITCH" =      "solid",
  "LIMES" =      "solid",
  "MEESA" =      "solid",
  "OSeMBE" =     "solid"
)

modelAlpha <- c(
  "Historical" =      1,
  "mean" =            1,
  "median" =          1,
  "IMAGE" =         0.5,
  "Euro-Calliope" = 0.5,
  "MESSAGE" =       0.5,
  "PRIMES" =        0.5,
  "PROMETHEUS" =    0.5,
  "REMIND" =        0.5,
  "TIAM-ECN" =      0.5,
  "TIAM-ECN 1.2" =  0.5,
  "WITCH" =         0.5, 
  "LIMES" =         0.5,
  "MEESA" =         0.5,
  "OSeMBE" =        0.5
)

modelsOrder <- c(
  "Historical",
  "mean",
  "median",
  "OSeMBE",
  "MEESA",
  "LIMES",
  "WITCH",
  "TIAM-ECN",
  "TIAM-ECN 1.2",
  "REMIND",
  "PROMETHEUS",
  "PRIMES",
  "MESSAGE",
  "IMAGE",
  "Euro-Calliope"
)

modelShape <- c(
  "Historical"    = NA, 
  "mean"          = NA, 
  "median"        = 21,
  "IMAGE"         = 21,
  "Euro-Calliope" = 21, 
  "MESSAGE"       = 21, 
  "PRIMES"        = 21, 
  "PROMETHEUS"    = 21, 
  "REMIND"        = 21, 
  "TIAM-ECN"      = 21, 
  "TIAM-ECN 1.2"  = 21, 
  "WITCH"         = 21,
  "LIMES"         = 23, 
  "MEESA"         = 23, 
  "OSeMBE"        = 23 
)

``` 


```{r paper_theme, echo=FALSE, include=FALSE}

theme_paper <- function(){
  theme_minimal(
    base_size = 24
    #, base_family = "Helvetica"
    ) +
    theme(
      # Panel background and grid
      panel.background = element_rect(fill = "white", colour = NA),
      panel.grid.major = element_line(colour = "grey90", size = .7),
      panel.grid.minor = element_line(colour = "grey95", size = .7),
      plot.background = element_rect(fill="#FFFFFF", color = NA),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      plot.margin = margin(r = 20, l = 20),
      # Axis lines, titles, and text
      axis.ticks = element_line(colour = "black", size = 0.5),
      axis.title = element_text(size = 14, face = "plain", colour = "black"),
      axis.text = element_text(size = 12, colour = "black"),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),	  
      # Plot title and subtitle
      plot.title = element_text(size = 16, face = "plain", hjust = 0, margin = margin(t = 10, b = 10), colour = "black"),
      plot.subtitle = element_text(size = 12, face = "plain", hjust = 0, margin = margin(b = 10), colour = "grey50"),	  
      # Legend
      legend.position = "bottom",
      legend.box = "horizontal",
      legend.title = element_blank(),
      legend.text = element_text(size = 12, colour = "black"),
      #legend.key.size = unit(0.5, "lines"),
      legend.key.width = unit(2, 'cm'),  
      # Strip for facets
      strip.background = element_rect(fill = "white", colour = NA),
      #strip.text = element_blank(),
      panel.spacing = unit(3, "lines")
    )
}

def <- list(
  grid = list(
    lineSize = .7,
    color = "grey90",
    linetype = "dashed"
  ),
  yAxis= list(
    linewidth = 2,
    alpha = 0.3
  ),
  hist = list(
    lineSize = 1.5,
    areaColor = "#eeeeee",
    alpha = 0.5
  ),
  model = list(
    lineSize = 0.8,
    pointSize = 0.5,
    pointStroke = 1.5,
    shape = 21,
    smallPointSize = 0.5,
    smallPointStroke = 1
  ),
  median = list(
    lineSize = 1.5,
    pointSize = 2,
    pointStroke = 2,
    shape = 21,
    smallPointSize = 1,
    smallPointStroke = 1
  ),
  decadeChange = list(
    lineSize = 0.5,
    wideLineSize = 0.5,
    wideAlpha = 0.3,
    pointSize = 1,
    pointStroke = 1
  )
)

dir.create(paste0(outFolder, "/png"), showWarnings = FALSE, recursive = TRUE)
dir.create(paste0(outFolder, "/svg"), showWarnings = FALSE, recursive = TRUE)

```


## Figure 1

<!-- ### Figure 1.a -->

<!-- Greenhouse gas emissions for scenarios reaching climate neutrality by 2050 -->

<!-- Decadal average of the annual percentage change in the median model results, expressed relative to 1990 baseline values, shown in blue. -->

```{r figure_1, echo=FALSE, include=FALSE}

plotDataRaw <- df %>%
  filter(variable == "Emi|Kyoto Gases|synthetic",
         period >=2010, period <= 2050,
         scenario %in% c("WP1 NetZero"),
         model %in% modelsFullSystem, 
         region == "EU27 & UK (*)") %>%
  rbind(
    df %>%
      filter(variable == "Emissions|CO2|Energy and Industrial Processes",
             period >=2010, period <= 2050,
             model %in% modelsFullSystem,
             scenario %in% c("WP1 NetZero"),
             region == "EU27 & UK (*)")
  ) %>%
  rbind(
    histData %>%
      filter(variable == "Emi|GHG|w/ Bunkers",
             region == "EUR",
             model == "UNFCCC") %>%
      mutate(variable = "Emi|Kyoto Gases|synthetic",
             model = "Historical") %>%
      rbind(
        histData %>%
          filter(variable == "Emi|CO2|w/ Bunkers|Energy and Industrial Processes",
                 region == "EUR",
                 model == "UNFCCC") %>%
          mutate(variable = "Emissions|CO2|Energy and Industrial Processes",
                 model = "Historical")
      )
  )

plotData <- plotDataRaw %>%
  rbind(
    plotDataRaw %>%
      filter(model != "Historical") %>%
      group_by(scenario, region, variable, unit, period) %>%
      summarise(median_value = median(value, na.rm = TRUE)) %>%
      ungroup() %>%
      rename(value = median_value) %>%
      mutate(model = "median") %>%
      select(all_of(names(plotDataRaw)))
  ) %>%
  mutate(model = factor(model, levels=rev(modelsOrder)))

decade_change <- plotData %>% 
  filter(model == "median", period %% 10 == 0, period > 2020) %>%
  rbind(
    plotData %>%
      filter(model == "Historical", period %% 10 == 0, period <= 2020)
  ) %>%
  select(period, variable, value) %>%
  arrange(variable,period) %>%
  group_by(variable) %>%
  mutate(
    change_in_10_years = value - lag(value),
    change_percentage = ((change_in_10_years) / value[period == 1990])/10 * 100,
    prev_period = lag(period),
    prev_value = lag(value)
  ) %>%
  #filter(!is.na(prev_period)) %>%
  mutate(
    x = (period + prev_period) / 2,
    y = (value + prev_value) / 2,
    vAlign = case_when(
      period == 2000 ~ -0.5, 
      period == 2020 ~ -2.5, 
      period %in% c(2030, 2040) ~ -3.0,
      #period == 2050 ~ 1.5,
      TRUE ~ -1.5
    )
  )

limitY <- max(plotData$value)

g_data <- list(
  "Emi|Kyoto Gases|synthetic" = list(
    data = plotData %>% filter(variable == "Emi|Kyoto Gases|synthetic"),
    decade_change = decade_change %>% filter(variable == "Emi|Kyoto Gases|synthetic"),
    title = "GHG Emissions",
    subtitle = expression(paste("Mt ", CO[2]," eq/yr"))
  ),
  "Emissions|CO2|Energy and Industrial Processes" = list(
    data = plotData %>% filter(variable == "Emissions|CO2|Energy and Industrial Processes"),
    decade_change = decade_change %>% filter(variable == "Emissions|CO2|Energy and Industrial Processes"),
    title = expression(paste(CO[2],"  Emissions - energy and industrial processes")),
    subtitle = expression(paste("Mt ", CO[2]," /yr"))
  )
)

g <- list()
for( chart in names(g_data)){
  g[[chart]] <- ggplot(g_data[[chart]][["data"]],aes(x=period,y=value)) +
    geom_segment(data= g_data[[chart]][["data"]] %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
    annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
    annotate("text", x = 2005, y = 3000, label = "Historical", hjust = 0.5, vjust = 0.5, size = 15/.pt, color = "#888888") + # historical text
    geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
    geom_line(data=g_data[[chart]][["data"]] %>% filter((!(model %in% c("Historical", "median")))), size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
    geom_point(data = g_data[[chart]][["data"]] %>% filter(!(model %in% c("Historical", "median")), period > 2023), shape = def$median$shape, aes(colour = model), fill = "white", size = def$model$pointSize, stroke = def$model$pointStroke) +
    geom_line(data=g_data[[chart]][["data"]] %>% filter(model == "median"), size=def$median$lineSize,aes(color=model,linetype=model, alpha = model)) +
    geom_point(data = g_data[[chart]][["data"]] %>% filter(model == "median"), shape = def$median$shape, aes(colour = model), fill = "white", size = def$median$pointSize, stroke = def$median$pointStroke) +
    geom_line(data=g_data[[chart]][["data"]] %>% filter(model == "Historical"), size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) +
    geom_label(data = g_data[[chart]][["decade_change"]] %>% filter(!is.na(prev_value)), aes(x = x, y = y, label = paste0(round(change_percentage, 1), "% / yr"), vjust = vAlign), fill = "#90D5FF", color = "black", label.padding = unit(0.25, "lines"), label.r = unit(0.15, "lines"), hjust = 0.5, label.size = 0, alpha = 0.5) +
    theme_paper() +
    facet_wrap(~ variable) + 
    scale_color_manual(name = "legend", values = setNames(color[levels(plotData$model)],levels(plotData$model)), guide = guide_legend(nrow = 2)) +
    scale_alpha_manual(values = modelAlpha) +
    scale_linetype_manual(values = modelLinetype) +
    labs(title = g_data[[chart]][["title"]], subtitle = g_data[[chart]][["subtitle"]]) + 
    scale_x_continuous(expand = c(0, 0)) +
    expand_limits(y = limitY) +
    coord_cartesian(clip = 'off') +
    theme(strip.text = element_blank()) +
    guides(linetype = "none", alpha = "none")
}

# function to extract the legend
g_legend <- function(a.gplot){ 
    tmp <- ggplot_gtable(ggplot_build(a.gplot)) 
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box") 
    legend <- tmp$grobs[[leg]] 
    legend
} 

g[["legend"]] <- g_legend(g$`Emi|Kyoto Gases|synthetic` + theme(plot.margin = margin(t = 20)))

g[["Figure 1.a"]] <- gridExtra::arrangeGrob(
  g$`Emi|Kyoto Gases|synthetic` + theme(legend.position="none"),
  g$`Emissions|CO2|Energy and Industrial Processes` + theme(legend.position="none"),
  g[["legend"]],
  layout_matrix = rbind(c(1, 2),
                        c(1, 2),
                        c(1, 2),
                        c(1, 2),
                        c(1, 2),
                        c(3, 3))
   )

```

<!-- ### Figure 1.b -->

<!-- Electricity Supply CO2 emissions -->

<!-- Decadal average of the annual percentage change in the median model results, expressed relative to 2000 baseline values, shown in blue. -->

```{r figure 1.b, echo=FALSE, include=FALSE}

plotDataRaw <- df %>%
  filter(variable == "Emissions|CO2|Energy|Supply|Electricity",
         period >=2010, period <= 2050,
         scenario %in% c("WP1 NetZero"),
         model %in% modelsElecall, 
         region == "EU27 & UK (*)") %>%
  rbind(
    histData %>%
    filter(variable == "Emi|CO2|Energy|Supply|Electricity w/ couple prod",
           region == "EUR",
           model == "Ember") %>%
      mutate(variable = "Emissions|CO2|Energy|Supply|Electricity",
             model = "Historical")
    )

plotData <- plotDataRaw %>%
  rbind(
    plotDataRaw %>%
      filter(model != "Historical") %>%
      group_by(scenario, region, variable, unit, period) %>%
      summarise(median_value = median(value, na.rm = TRUE)) %>%
      ungroup() %>%
      rename(value = median_value) %>%
      mutate(model = "median") %>%
      select(all_of(names(plotDataRaw)))
  ) %>%
  mutate(model = factor(model, levels=rev(modelsOrder)))

decade_change <- plotData %>% 
  filter(model == "median", period %% 10 == 0, period > 2020) %>%
  rbind(
    plotData %>%
      filter(model == "Historical", period %% 10 == 0, period <= 2020)
  ) %>%
  select(period, variable, value) %>%
  arrange(variable,period) %>%
  group_by(variable) %>%
  mutate(
    change_in_10_years = value - lag(value),
    change_percentage = ((change_in_10_years) / value[period == 2000])/10 * 100,
    prev_period = lag(period),
    prev_value = lag(value)
  ) %>%
  mutate(
    x = (period + prev_period) / 2,
    y = (value + prev_value) / 2,
    vAlign = case_when(
      #period == 2040 ~ 1.8,
      period %in% c(2020,2030) ~ -3.0,
      TRUE ~ -1.5
    )
  )

g[["Figure 1.b"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_segment(data = plotData %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
  annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
  annotate("text", x = 2010, y = 750, label = "Historical", hjust = 0.5, vjust = 0.5, size = 15/.pt, color = "#888888") + # historical text
  geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
  geom_line(data=plotData %>% filter((!(model %in% c("Historical", "median")))), size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(model != "median", period > 2023), aes(colour = model, shape = model), fill = "white", size = def$model$pointSize, stroke = def$model$pointStroke) +
  geom_line(data=plotData %>% filter(model == "median"), size=def$median$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(model == "median"), aes(colour = model, shape = model), fill = "white", size = def$median$pointSize, stroke = def$median$pointStroke) +
  geom_line(data=plotData %>% filter(model == "Historical"), size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + 
  geom_label(data = decade_change %>% filter(!is.na(prev_value)), aes(x = x, y = y, label = paste0(round(change_percentage, 1), "% / yr"), vjust = vAlign), fill = "#90D5FF", color = "black", label.padding = unit(0.25, "lines"), label.r = unit(0.15, "lines"), hjust = 0.5, label.size = 0, alpha = 0.5) +
  theme_paper() + 
  scale_color_manual(name = "legend", values = setNames(color[levels(plotData$model)], levels(plotData$model)), guide = guide_legend(ncol = 2)) +
  scale_alpha_manual(values = modelAlpha) +
  scale_linetype_manual(values = modelLinetype) +
  scale_shape_manual(name = "legend", values = modelShape, guide = guide_legend(ncol = 2)) +
  labs(title = expression(paste("Electricity Supply ", CO[2]," Emissions")), subtitle = expression(paste("Mt ", CO[2]," /yr"))) +
  scale_x_continuous(expand = c(0, 0)) +
  coord_cartesian(clip = 'off') + 
  theme(legend.position = "right",
        legend.key.height = unit(1, 'cm'),
        plot.margin = margin(r = 100, l = 100),
        legend.margin = margin(l = 50),
        strip.text = element_blank()
  ) +
  guides(linetype = "none", alpha = "none")

```

<!-- ### Figure 1 -->

```{r figure 1, echo=FALSE, include=FALSE}

g[["Figure 1"]] <- gridExtra::arrangeGrob(
  g$`Emi|Kyoto Gases|synthetic` + 
    theme(legend.position="none") + 
    labs(title = "(a) GHG Emissions", subtitle = expression(paste("Mt ", CO[2]," eq/yr"))) +
    theme(plot.margin = margin(b = 10, r=20)),
  g$`Emissions|CO2|Energy and Industrial Processes` +
    theme(legend.position="none") +
    labs(title = expression(paste("(b) ", CO[2], " Emissions - energy and industrial processes")), subtitle = expression(paste("Mt ", CO[2]," eq/yr"))) +
    theme(plot.margin = margin(b = 10, r=20)),
  g[["Figure 1.b"]] + 
    theme(plot.margin = margin(r = 60, t = 10), legend.margin = margin(l = 80)) + 
    labs(title = expression(paste("(c) Electricity Supply ", CO[2]," Emissions")), subtitle = expression(paste("Mt ", CO[2]," eq/yr"))),
  layout_matrix = rbind(c(1, 2),
                        c(3, 3))
   )

ggsave(paste0(outFolder, "/png/Figure 1 Emissions panel.png"), g[["Figure 1"]], device="png", width = 12, height = 10, dpi=300, units = "in")
ggsave(paste0(outFolder, "/svg/Figure 1 Emissions panel.svg"), g[["Figure 1"]], device="svg", width = 12, height = 10, dpi=100, units = "in")

```


```{r, echo=FALSE, fig.width=12, fig.height=10}

grid.newpage()
grid.draw(g[["Figure 1"]])

```

Figure 1. Emissions panel (EU27 and UK). Historical UNFCCC (figure 1.a and 1.b) and Ember (Figure 1.c) data shown in black. Decadal average of the annual percentage change in the median model results, expressed relative to 1990 (figure 1.a and 1.b) or 2000 (figure 1.c) baseline values, shown in blue.

---

## Figure 2

<!-- Electricity Generation from Wind and Solar and Share in electricity generation -->

```{r SE_Electricity_VRE, echo=FALSE, include=FALSE}

plotDataRaw <- df %>%
  filter(variable == "Secondary Energy|Electricity|WindSolar",
         period >=2010, period <= 2050,
         scenario %in% c("WP1 NetZero"),
         model %in% modelsElecall, 
         region == "EU27 & UK (*)") %>%
  rbind(
    histData %>%
    filter(variable == "SE|Electricity|WindSolar",
           region == "EUR",
           model == "Ember") %>%
      mutate(variable = "Secondary Energy|Electricity|WindSolar",
             model = "Historical")
    ) %>%
  mutate(value = value*277.7777778) # EJ 2 TWh

plotData <- plotDataRaw %>%
  rbind(
    plotDataRaw %>%
      filter(model != "Historical") %>%
      group_by(scenario, region, variable, unit, period) %>%
      summarise(median_value = median(value, na.rm = TRUE)) %>%
      ungroup() %>%
      rename(value = median_value) %>%
      mutate(model = "median") %>%
      select(all_of(names(plotDataRaw)))
  ) %>%
  mutate(model = factor(model, levels=rev(modelsOrder)))

decade_change <- plotData %>% 
  filter(model == "median", period %% 10 == 0, period > 2020) %>%
  rbind(
    plotData %>%
      filter(model == "Historical", period %% 10 == 0, period <= 2020)
  ) %>%
  select(period, variable, value) %>%
  arrange(variable,period) %>%
  group_by(variable) %>%
  mutate(
    change_in_10_years = value - lag(value),
    change_percentage = ((change_in_10_years) / lag(value))/10*100,
    prev_period = lag(period),
    prev_value = lag(value)
  ) %>%
  #filter(!is.na(prev_period)) %>%
  mutate(
    x = (period + prev_period) / 2,
    y = (value + prev_value) / 2,
    vAlign = case_when(
      TRUE ~ -1.5
    )
  )

g[["Electricity Generation from Wind and Solar"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_segment(data = plotData %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
  annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
  annotate("text", x = 2012, y = 5000, label = "Historical", hjust = 0.5, vjust = 0.5, size = 15/.pt, color = "#888888") + # historical text
  geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
  geom_line(data = plotData %>% filter((!(model %in% c("Historical", "median")))),size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(period > 2023, model != "median"), aes(colour = model, shape = model), fill = "white", size = def$model$pointSize, stroke = def$model$pointStroke) +
  geom_line(data=plotData %>% filter(model == "median"), size=def$median$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(model == "median"), aes(colour = model, shape = model), fill = "white", size = def$median$pointSize, stroke = def$median$pointStroke) +
  geom_line(data=plotData %>% filter(model == "Historical"), size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + 
  theme_paper() +
  scale_color_manual(name = "legend",values = setNames(color[levels(plotData$model)],levels(plotData$model)), guide = guide_legend(nrow = 2)) +
  scale_alpha_manual(values = modelAlpha) +
  scale_linetype_manual(values = modelLinetype) +
  scale_shape_manual(name = "legend",values = modelShape, guide = guide_legend(nrow = 2)) +
  labs(title = "(a) Electricity Generation from Wind and Solar", subtitle = "TWh/yr") + 
  scale_x_continuous(expand = c(0, 0)) +
  coord_cartesian(clip = 'off') +
  theme(strip.text = element_blank()) +
  expand_limits(y = c(0,1)) +
  guides(linetype = "none", alpha = "none")

plotDataRaw <- df %>%
  filter(variable == "Secondary Energy|Electricity|VRE Share",
         period >=2010, period <= 2050,
         scenario %in% c("WP1 NetZero"),
         model %in% modelsElecall, 
         region == "EU27 & UK (*)") %>%
  rbind(
    histData %>%
    filter(variable == "SE|Electricity|VRE Share",
           region == "EUR",
           model == "Ember") %>%
      mutate(variable = "Secondary Energy|Electricity|VRE Share",
             model = "Historical")
    )


plotData <- plotDataRaw %>%
  rbind(
    plotDataRaw %>%
      filter(model != "Historical") %>%
      group_by(scenario, region, variable, unit, period) %>%
      summarise(median_value = median(value, na.rm = TRUE)) %>%
      ungroup() %>%
      rename(value = median_value) %>%
      mutate(model = "median") %>%
      select(all_of(names(plotDataRaw)))
  ) %>%
  mutate(model = factor(model, levels=rev(modelsOrder)))

decade_change <- plotData %>% 
  filter(model == "median", period %% 10 == 0, period > 2020) %>%
  rbind(
    plotData %>%
      filter(model == "Historical", period %% 10 == 0, period <= 2020)
  ) %>%
  select(period, variable, value) %>%
  arrange(variable,period) %>%
  group_by(variable) %>%
  mutate(
    change_in_10_years = value - lag(value),
    change_percentage = ((change_in_10_years) / lag(value))/10*100,
    prev_period = lag(period),
    prev_value = lag(value)
  ) %>%
  mutate(
    x = (period + prev_period) / 2,
    y = (value + prev_value) / 2,
    vAlign = case_when(
      TRUE ~ -1.5
    )
  )

g[["Share in electricity generation"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_segment(data = plotData %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
  annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
  annotate("text", x = 2012, y = 0.5, label = "Historical", hjust = 0.5, vjust = 0.5, size = 15/.pt, color = "#888888") + # historical text
  geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
  geom_line(data=plotData %>% filter((!(model %in% c("Historical", "median")))), size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(period > 2023, model != "median"), aes(colour = model, shape = model), fill = "white", size = def$model$pointSize, stroke = def$model$pointStroke) +
  geom_line(data=plotData %>% filter(model == "median"), size=def$median$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(model == "median"), aes(colour = model, shape = model), fill = "white", size = def$median$pointSize, stroke = def$median$pointStroke) +
  geom_line(data=plotData %>% filter(model == "Historical"), size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + 
  theme_paper() +
  scale_color_manual(name = "legend", values = setNames(color[levels(plotData$model)],levels(plotData$model)), guide = guide_legend(nrow = 2)) +
  scale_alpha_manual(values = modelAlpha) +
  scale_linetype_manual(values = modelLinetype) +
  scale_shape_manual(name = "legend", values = modelShape, guide = guide_legend(nrow = 2)) +
  labs(title = "(b) Share in electricity generation", subtitle = "%") + 
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2), limits = c(0,1), expand = c(0, 0)) +
  coord_cartesian(clip = 'off') +
  theme(strip.text = element_blank()) +
  expand_limits(y = c(0,1)) +
  guides(linetype = "none", alpha = "none")

g[["legend"]] <- g_legend(g$`Electricity Generation from Wind and Solar` + guides(color = guide_legend(nrow = 2)) + theme(plot.margin = margin(t = 20)))

g[["Figure 2"]] <- gridExtra::arrangeGrob(
  g$`Electricity Generation from Wind and Solar` + theme(legend.position="none", plot.margin = margin(r=10, l=20)),
  g$`Share in electricity generation` + theme(legend.position="none", plot.margin = margin(r=20, l=10, b=15), 
                                              #plot.subtitle = element_text(margin = margin(b = 40))
                                              ),
  g[["legend"]],
  layout_matrix = rbind(c(1, 2),
                        c(1, 2),
                        c(1, 2),
                        c(1, 2),
                        c(1, 2),
                        c(3, 3))
   )


ggsave(paste0(outFolder, "/png/Figure 2. Electricity Generation from Wind and Solar and Share in electricity generation.png"), g[["Figure 2"]], device="png", width = 12, height = 6, dpi=300, units = "in")
ggsave(paste0(outFolder, "/svg/Figure 2. Electricity Generation from Wind and Solar and Share in electricity generation.svg"), g[["Figure 2"]], device="svg", width = 12, height = 6, dpi=100, units = "in")


```


```{r, echo=FALSE, fig.width=12, fig.height=6}

grid.newpage()
grid.draw(g[["Figure 2"]])

```

Figure 2. Variable renewables generation and electricity share. Decadal average of the annual percentage change in the median model results, expressed relative to the preceding decade, shown in blue.


---


## Figure 3

<!-- Share of electricity and hydrogen in final energy -->

```{r fe_electricity_and_hydrogen_share, echo=FALSE, include=FALSE}

plotDataRaw <- df %>%
  filter(variable %in% c("Final Energy|Electricity Share woBunkers woNonEnergy", "Final Energy|Hydrogen Share woBunkers woNonEnergy"),
         period >=2010, period <= 2050,
         scenario %in% c("WP1 NetZero"),
         model %in% modelsFullSystem, 
         region == "EU27 & UK (*)") %>%
  rbind(
    histData %>%
    filter(variable == "Final Energy|Electricity Share woBunkers woNonEnergy",
           region == "EUR",
           period >=2000,
           model == "IEA") %>%
      mutate(variable = "Final Energy|Electricity Share woBunkers woNonEnergy",
             model = "Historical")
    )

plotData <- plotDataRaw %>%
  rbind(
    plotDataRaw %>%
      filter(model != "Historical") %>%
      group_by(scenario, region, variable, unit, period) %>%
      summarise(median_value = median(value, na.rm = TRUE)) %>%
      ungroup() %>%
      rename(value = median_value) %>%
      mutate(model = "median") %>%
      select(all_of(names(plotDataRaw)))
  ) %>%
  mutate(model = factor(model, levels=rev(modelsOrder)),
         carrier = ifelse(variable == "Final Energy|Electricity Share woBunkers woNonEnergy", "Electricity", "Hydrogen")
  )
  

decade_change <- plotData %>% 
  filter(model == "median", period %% 10 == 0, period > 2020) %>%
  rbind(
    plotData %>%
      filter(model == "Historical", period %% 10 == 0, period <= 2020)
  ) %>%
  select(period, variable, value) %>%
  arrange(variable,period) %>%
  group_by(variable) %>%
  mutate(
    change_in_10_years = value - lag(value),
    change_percentage = ((change_in_10_years) / lag(value))/10*100,
    prev_period = lag(period),
    prev_value = lag(value)
  ) %>%
  mutate(
    x = (period + prev_period) / 2,
    y = (value + prev_value) / 2,
    vAlign = case_when(
      period %in% c(2010, 2020) ~ - 0.5,
      TRUE ~ -1.5
    )
  )

 g[["Figure 3"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_segment(data = plotData %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
  annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
  annotate("text", x = 2012, y = 0.5, label = "Historical", hjust = 0.5, vjust = 0.5, size = 15/.pt, color = "#888888") + # historical text
  geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
  geom_line(data=plotData %>% filter((!(model %in% c("Historical", "median")))), size=def$model$lineSize,aes(color=model,linetype=carrier, alpha = model), show.legend = c(linetype = FALSE, colour = TRUE)) + # models data
  geom_point(data = plotData %>% filter(!(model %in% c("Historical", "median")), period > 2023), shape = def$model$shape, aes(colour = model), fill = "white", size = def$model$pointSize, stroke = def$model$pointStroke) +
  geom_line(data=plotData %>% filter(model == "median"), size=def$median$lineSize,aes(color=model,linetype=carrier, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(model == "median"), shape = def$median$shape, aes(colour = model, shape = model), fill = "white", size = def$median$pointSize, stroke = def$median$pointStroke) +
  geom_line(data=plotData %>% filter(model == "Historical"), size=def$model$lineSize,aes(color=model, alpha = model), linetype = "solid") + 
  theme_paper() +
  scale_color_manual(name = "legend", values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
  scale_alpha_manual(values = modelAlpha) +
  scale_linetype_manual(name = "legend2", values = c("Electricity" = "solid", "Hydrogen" = "dashed")) +
  labs(title = "Electricity and Hydrogen share in final energy use", subtitle = "%") +
  scale_x_continuous(expand = c(0, 0)) +
  coord_cartesian(clip = 'off') +
  theme(strip.text = element_blank()) +
  expand_limits(y = c(0,1)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 0.7, by = 0.1), limits = c(0,0.75)) + 
  theme(plot.margin = margin(r = 125, l = 125)) +
  guides(
    color = guide_legend(order = 1, nrow = 2),
    linetype = guide_legend(order = 2, nrow = 2),
    alpha = "none")

 ggsave(paste0(outFolder, "/png/Figure 3. Share of electricity and hydrogen in final energy.png"), g[["Figure 3"]], device="png", width = 12, height = 6, dpi=300, units = "in")
 ggsave(paste0(outFolder, "/svg/Figure 3. Share of electricity and hydrogen in final energy.svg"), g[["Figure 3"]], device="svg", width = 12, height = 6, dpi=100, units = "in")
 
```



```{r, echo=FALSE, fig.width=12, fig.height=6}

g[["Figure 3"]]

```


Figure 3. Electricity and hydrogen final energy shares. 
<!-- Decadal average of the annual percentage change in the median model results, expressed relative to the preceding decade, shown in blue. -->


---


## Figure 4

<!-- Left: Carbon-containing final energy. Right: Energy imports  -->


```{r Carbon-containing final energy, echo=FALSE, include=FALSE}

  vars <- list(
  "Synfuel - Gases"   = "Final Energy|Gases|Electricity",
  "Synfuel - Liquids" = "Final Energy|Liquids|Electricity",
  "Biomass - Gases"   = "Final Energy|Gases|Biomass",
  "Biomass - Liquids" = "Final Energy|Liquids|Biomass",
  "Biomass - Solids"  = "Final Energy|Solids|Biomass",
  "Fossils - Gases"   = "Final Energy|Gases|Fossil",   
  "Fossils - Liquids" = "Final Energy|Liquids|Fossil",
  "Fossils - Solids"  = "Final Energy|Solids|Fossil")

  carrier_color <- c(  
    "Synfuel - Gases"   = "#5ed5f0",
    "Synfuel - Liquids" = "#0177d4",
    "Biomass - Gases"   = "#33ed27",
    "Biomass - Liquids" = "#23ae1a",
    "Biomass - Solids"  = "#005900",
    "Fossils - Gases"   = "#c8c8c8",
    "Fossils - Liquids" = "#727272",
    "Fossils - Solids"  = "#0c0c0c")
  
  varToCarrier <- setNames(gsub("\\d+$", "", names(unlist(vars))),unlist(vars))

  plotData <- df %>%
    filter(variable %in% names(varToCarrier),
           period %in% c(2020,2030,2040,2050),
           model %in% modelsFullSystem,
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(model = factor(model, levels=rev(modelsOrder)),
           carrier = factor(varToCarrier[as.character(variable)], levels = names(vars))) %>%
    group_by(model,scenario,region,carrier,period) %>%
    summarise(value = sum(value))
     
  minfe <- plotData %>% group_by(model,period) %>% summarize(value= sum(value)) %>% pull(value) %>% min()
  maxfe <- plotData %>% group_by(model,period) %>% summarize(value= sum(value)) %>% pull(value) %>% max()
  
  plotDataTotal <- df %>%
    filter(variable == "FE|SolLiqGas",
           model %in% modelsFullSystem,
           period %in% c(2020,2030,2040,2050),
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(model = factor(model, levels=rev(modelsOrder)))
    
  g[["Carbon-containing final energy"]] <- ggplot(plotData) +
    #geom_rect(data = data.frame(period = 2020), xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "#eeeeee", alpha = 0.5) +
    geom_bar(stat='identity', alpha = 0.8, aes(x=model, y=value, fill=carrier)) +
    geom_point(data = plotDataTotal, aes(x=model, y = value), colour = "black", size = 3, shape = 18) +
    facet_wrap(~period,nrow=1) +
    theme_paper() +
    scale_fill_manual(values = carrier_color, guide = guide_legend(nrow = 3)) +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5)) +
    labs(title = "(a) Carbon-containing final energy", subtitle = "EJ/yr") +
    theme(legend.key.width = unit(0.7, 'cm'))
    
```

```{r Energy imports, echo=FALSE, include=FALSE}

  vars <- list(
    "Electricity" = "Trade|Secondary Energy|Electricity|Volume",
    "Hydrogen"    = "Trade|Secondary Energy|Hydrogen|Volume",
    "Liquids (Synfuel)" = c("Trade|Secondary Energy|Liquids|Electricity|Volume","Trade|Secondary Energy|Liquids|Hydrogen|Volume"),
    "Liquids (bio-based)" = "Trade|Secondary Energy|Liquids|Biomass|Volume",
    "Biomass" = c("Trade|Secondary Energy|Solids|Biomass|Volume", "Trade|Primary Energy|Biomass|Volume"),
    "Gas" = "Trade|Primary Energy|Gas|Volume",
    "Oil" = c("Trade|Secondary Energy|Liquids|Oil|Volume","Trade|Primary Energy|Oil|Volume"),
    "Coal - Liquids" = "Trade|Secondary Energy|Liquids|Coal|Volume",
    "Coal" = "Trade|Primary Energy|Coal|Volume"
  )

 carrier_color <- c(  
    "Electricity"         = "#fff300",
    "Hydrogen"            = "#00ffe4",
    "Liquids (Synfuel)"   = "#0177d4",
    "Liquids (bio-based)" = "#23ae1a",
    "Biomass"             = "#005900",
    "Gas"                 = "#b3b34b",
    "Oil"                 = "#f4786d",
    "Coal - Liquids"      = "#727272",
    "Coal"                = "#0c0c0c"
  ) 
 
  varToCarrier <- setNames(gsub("\\d+$", "", names(unlist(vars))),unlist(vars))

  histVars <- list(
    "Gas"  = "Trade|Gas",
    "Oil"  = "Trade|Oil",
    "Coal" = "Trade|Coal"
  )
  
  histVarToCarrier <- setNames(gsub("\\d+$", "", names(unlist(histVars))),unlist(histVars))
   
  plotData <- df %>%
    filter(variable %in% names(varToCarrier),
           period %in% c(2020,2030,2040,2050),
           model %in% modelsFullSystem,
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(carrier = factor(varToCarrier[as.character(variable)], levels = names(vars))) %>%
    rbind(
      histData  %>%
        filter(variable %in% names(histVarToCarrier),
               region == "EUR",
               period %in% c(2020,2030,2040,2050),
               model == "IEA") %>%
          mutate(carrier = factor(histVarToCarrier[as.character(variable)], levels = names(vars)),
                 model = "Historical")
      ) %>%
    group_by(model,scenario,region,carrier,period) %>%
    summarise(value = sum(value)) %>%
    mutate(model = factor(model, levels=rev(c(modelsOrder[modelsOrder != "Historical"], "Historical"))),
           value = value * - 1)
  
  minMport <- plotData %>% group_by(model,period) %>% summarize(value= sum(value)) %>% pull(value) %>% min()
  maxMport <- plotData %>% group_by(model,period) %>% summarize(value= sum(value)) %>% pull(value) %>% max()
  
  limitY <- c(min(minfe, minMport), max(maxfe,maxMport))
  
  g[["Energy imports"]] <- ggplot(plotData) +
    geom_bar(stat='identity', alpha = 0.8,aes(x=model,y=value,fill=carrier)) +
    facet_wrap(~period,nrow=1, scales = "free_x") +
    theme_paper() +
    scale_fill_manual(values = carrier_color, guide = guide_legend(nrow = 3)) +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5)) +
    labs(title = "(b) Energy imports", subtitle = "EJ/yr") +
    theme(legend.key.width = unit(0.7, 'cm')) +
    force_panelsizes(cols = plotData %>% select(model, period) %>% group_by(period) %>% summarize(unique_count = n_distinct(model)) %>% pull(unique_count))
	
    
```


```{r Carbon-containing final energy and energy imports, echo=FALSE, include=FALSE}

#g[["legend"]] <- g_legend(g$`Energy imports` + guides(color = guide_legend(nrow = 1)) + theme(plot.margin = margin(t = 20)))

g[["Figure 4"]] <- gridExtra::arrangeGrob(
  g$`Carbon-containing final energy` + 
    expand_limits(y = limitY),
  g$`Energy imports` +
    expand_limits(y = limitY),
  layout_matrix = rbind(c(1, 2))
   )

ggsave(paste0(outFolder, "/png/Figure 4. Carbon-containing final energy and energy imports.png"), g[["Figure 4"]], device="png", width = 12, height = 8, dpi=300, units = "in")
ggsave(paste0(outFolder, "/svg/Figure 4. Carbon-containing final energy and energy imports.svg"), g[["Figure 4"]], device="svg", width = 12, height = 8, dpi=100, units = "in")


```


```{r, echo=FALSE, fig.width=12, fig.height=8}

grid.newpage()
grid.draw(g[["Figure 4"]])

```


Figure 4. Residual carbon and energy imports.


---


## Figure 5

<!-- Emissions per sector -->


```{r Emissions per sector, echo=FALSE, include=FALSE}

  vars <- c(
    "Demand - Bunkers"            = "Emissions|CO2|Energy|Demand|Bunkers",
    "non-CO2"                     = "Emissions|Kyoto Gases|non-CO2 synthetic",
    "other CO2"                   = "Emissions|CO2|Other",
    "Demand - AFOFI"              = "Emissions|CO2|Energy|Demand|AFOFI",
    "Demand - Buildings"          = "Emissions|CO2|Energy|Demand|Residential and Commercial",
    "Demand - Industry"           = "Gross Emissions|CO2|Energy|Demand|Industry",
    "Industrial Processes"        = "Gross Emissions|CO2|Industrial Processes",
    "Demand - Transport"          = "Emissions|CO2|Energy|Demand|Transportation",
    #"Demand - Other Sector"      = "Emissions|CO2|Energy|Demand|Other",
    "Energy Supply - Other"       = "Gross Emissions|CO2|Energy|Supply|Other",
    "Energy Supply - H2"          = "Gross Emissions|CO2|Energy|Supply|H2",
    "Energy Supply - Solids"      = "Gross Emissions|CO2|Energy|Supply|Solids",
    "Energy Supply - Liquids"     = "Gross Emissions|CO2|Energy|Supply|Liquids",
    "Energy Supply - Gases"       = "Gross Emissions|CO2|Energy|Supply|Gases",
    "Energy Supply - Heat"        = "Gross Emissions|CO2|Energy|Supply|Heat",
    "Energy Supply - Electricity" = "Gross Emissions|CO2|Energy|Supply|Electricity",
    "LULUCF"                      = "Emissions|CO2|AFOLU synthetic",
    "Geological Carbon Removal"   = "Carbon Removal|Geological Storage|Integrated"#,
    # "Other Removal"             = "Emissions|CO2|Other Removal"
    )

  totalVars <- c(
    "Total Kyoto Gases"                             = "Emi|Kyoto Gases|synthetic"
    )
  
  varToSector <- setNames(c(names(vars),rev(names(totalVars))), c(vars,rev(totalVars)))

  histVars <- c(
    "Demand - Bunkers"            = c("Emi|CO2|Energy|Demand|Transport|International Bunkers"),
    "non-CO2"                     = c("Emi|Kyoto Gases|non-CO2 calc"),
    "Demand - Buildings"          = c("Emi|CO2|Energy|Demand|Buildings"),
    "Demand - Industry"           = c("Emi|CO2|Energy|Demand|Industry"),
    "Industrial Processes"        = c("Emi|CO2|Industrial Processes"),
    "Demand - Transport"          = c("Emi|CO2|Energy|Demand|Transport"),
    "Energy Supply - Other"       = c("Emi|CO2|Calc Other"),
    "Energy Supply - Solids"      = c("Emi|CO2|Energy|Supply|Solids w/ couple prod"),
    "Energy Supply - Liquids"     = c("Emi|CO2|Energy|Supply|Liquids w/ couple prod"),
    "Energy Supply - Electricity" = c("Emi|CO2|Energy|Supply|Electricity and Heat"),
    "LULUCF"                      = c("Emi|GHG|Land-Use Change")
    )
  
  totalHistVars <- c(
    "Total Kyoto Gases"                             = "Emi|GHG|w/ Bunkers"
    )
  
  histVarToSector <- setNames(c(names(histVars),names(totalHistVars)),c(histVars,totalHistVars))

  sector_color <- c(  
    "Demand - Bunkers"            = "#283280",
    "non-CO2"                     = "purple",
    "other CO2"                   = "black",
    "Demand - AFOFI"              = "#6df25e",
    "Demand - Buildings"          = "#eba357",
    "Demand - Industry"           = "#ba6759",
    "Industrial Processes"        = "#735550",
    "Demand - Transport"          = "#a7c8db",
    #"Demand - Other Sector"      = "#5ed5f0",
    "Energy Supply - Other"       = "#ff33ff",
    "Energy Supply - H2"          = "#35effc",
    "Energy Supply - Solids"      = "#0c0c0c",
    "Energy Supply - Liquids"     = "#813499",
    "Energy Supply - Gases"       = "#337fff",
    "Energy Supply - Heat"        = "#b30000",
    "Energy Supply - Electricity" = "#fcec35",
    "LULUCF"                      = "darkgreen",
    "Geological Carbon Removal"   = "red"
    )

  totalShape <- c(
    "Total Kyoto Gases"                             = 17
    )
  
  plotData <- df %>%
    filter(variable %in% c(vars, totalVars),
           period %in% c(2020,2030,2040,2050),
           model %in% modelsFullSystem,
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(sector = varToSector[as.character(variable)]) %>%
    rbind(
      histData  %>%
        filter(variable %in% c(histVars, totalHistVars),
               region == "EUR",
               period == 2020,
               model == "UNFCCC") %>%
          mutate(sector = histVarToSector[as.character(variable)],
                 model = "Historical")
      ) %>%
    rbind(
      histData  %>%
        filter(variable %in% c(histVars, totalHistVars),
               region == "EUR",
               period %in% c(2018:2022),
               model == "UNFCCC") %>%
        group_by(model, scenario, region, variable, unit) %>%
        summarize(value = median(value, na.rm = TRUE)) %>%
        ungroup() %>%
        mutate(sector = histVarToSector[as.character(variable)],
               model = "Historical (5yr median)",
               period = "2020") %>%
        select(all_of(names(df)), sector)
      ) %>%
    mutate(model = factor(model, levels=rev(c(modelsOrder[modelsOrder != "Historical"], "Historical (5yr median)", "Historical"))),
           sector = factor(sector, levels = c(names(vars), names(totalVars))))
    

	g[["Emissions per sector"]] <- ggplot(plotData %>% filter(variable %in% c(vars, histVars))) +
    geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
	  geom_bar(stat='identity', alpha = 0.8,aes(x=model,y=value,fill=sector)) +
    geom_point(data = plotData %>% filter(variable %in% c(totalVars, totalHistVars)), aes(x=model, y = value, shape = sector), colour = "black", size = 3) + 
    facet_wrap(~period, nrow=1, scales = "free_x") +
    theme_paper() +
    scale_fill_manual(values = sector_color, breaks = rev(c("LULUCF", "Geological Carbon Removal", rev(names(sector_color)[!(names(sector_color) %in% c("LULUCF","Geological Carbon Removal"))])))) +
    scale_shape_manual(values = totalShape) +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5)) +
    labs(title = "(a) Emissions per sector", subtitle = expression(paste("Mt ", CO[2],"e /yr"))) +
    theme(legend.key.width = unit(0.7, 'cm'),
          legend.position = "right",
          legend.box = "vertical") + 
    guides(fill = guide_legend(order = 2), 
           shape = guide_legend(order = 1)) + 
    force_panelsizes(cols = plotData %>% select(model, period) %>% group_by(period) %>% summarize(unique_count = n_distinct(model)) %>% pull(unique_count))

```


```{r Carbon capture scale-up, echo=FALSE, include=FALSE}


plotDataRaw <- df %>%
  filter(variable %in% c("Carbon Capture"),
         period >= 2010, period <= 2050,
         scenario %in% c("WP1 NetZero"),
         model %in% modelsFullSystem,
         region == "EU27 & UK (*)")

plotData <- plotDataRaw %>%
  rbind(
    plotDataRaw %>%
      filter(model != "Historical") %>%
      group_by(scenario, region, variable, unit, period) %>%
      summarise(median_value = median(value, na.rm = TRUE)) %>%
      ungroup() %>%
      rename(value = median_value) %>%
      mutate(model = "median") %>%
      select(all_of(names(plotDataRaw)))
  ) %>%
  mutate(model = factor(model, levels=rev(modelsOrder)))

decade_change <- plotData %>% 
  filter(model == "median", period %% 10 == 0, period > 2020) %>%
  select(period, variable, value) %>%
  arrange(variable,period) %>%
  group_by(variable) %>%
  mutate(
    change_in_10_years = value - lag(value),
    change_percentage = ((change_in_10_years) / lag(value))/10*100,
    prev_period = lag(period),
    prev_value = lag(value)
  ) %>%
  mutate(
    x = (period + prev_period) / 2,
    y = (value + prev_value) / 2,
    vAlign = case_when(
      #period == 2050 ~ 1.4,
      TRUE ~ -1.5
    )
  )

g[["Carbon Capture"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_segment(data = plotData %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
  annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
  annotate("text", x = 2017.5, y = 500, label = "Historical", hjust = 0.5, vjust = 0.5, size = 15/.pt, color = "#888888") + # historical text
  geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
  geom_line(data=plotData %>% filter((!(model %in% c("Historical", "median")))), size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(!(model %in% c("Historical", "median")), period > 2023), shape = def$model$shape, aes(colour = model), fill = "white", size = def$model$pointSize, stroke = def$model$pointStroke) +
  geom_line(data=plotData %>% filter(model == "median"), size=def$median$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(model == "median"), aes(colour = model), shape = def$median$shape, fill = "white", size = def$median$pointSize, stroke = def$median$pointStroke) +
  theme_paper() +
  scale_color_manual(name = "legend", values = setNames(color[levels(plotData$model)],levels(plotData$model)), guide = guide_legend(ncol = 1)) +
  scale_alpha_manual(values = modelAlpha) +
  scale_linetype_manual(values = modelLinetype) +
  labs(title = "(b) Carbon Capture", subtitle = expression(paste("Mt ", CO[2]," /yr"))) + 
  scale_x_continuous(expand = c(0, 0)) +
  theme(strip.text = element_blank()) +
  coord_cartesian(clip = 'off') +
  theme(legend.position = "right",
        legend.box = "vertical") +
  guides(alpha = "none", linetype = "none")


```


```{r echo=FALSE, include=FALSE}

g[["Figure 5"]] <- gridExtra::arrangeGrob(
  g$`Emissions per sector`,
  g$`Carbon Capture` +
    theme(plot.margin = margin(l = 50, r = 50),  
          legend.margin = margin(l = 100, r = 50))
    ,
  layout_matrix = rbind(c(1),
                        c(1),
                        c(1),
                        c(2),
                        c(2))
   )

ggsave(paste0(outFolder, "/png/Figure 5. Emissions per sector and carbon capture scale-up.png"), g[["Figure 5"]], device="png", width = 12, height = 10, dpi=300, units = "in")
ggsave(paste0(outFolder, "/svg/Figure 5. Emissions per sector and carbon capture scale-up.svg"), g[["Figure 5"]], device="svg", width = 12, height = 10, dpi=100, units = "in")

```


```{r, echo=FALSE, fig.width=12, fig.height=10}

grid.newpage()
grid.draw(g[["Figure 5"]])

```

Figure 5. Emissions per sector and carbon capture scale-up.

---

## Figure 6

<!-- Carbon Price -->

```{r Carbon Price, echo=FALSE, include=FALSE}

plotDataRaw <- df %>%
    filter(variable == "Price|Carbon",
           period >=2015, period <= 2050,
           model %in% modelsElecall,
           scenario %in% c("WP1 NetZero"),
           region == "EU27 & UK (*)")

plotData <- plotDataRaw %>%
  rbind(
    plotDataRaw %>%
      filter(model != "Historical") %>%
      group_by(scenario, region, variable, unit, period) %>%
      summarise(median_value = median(value, na.rm = TRUE)) %>%
      ungroup() %>%
      rename(value = median_value) %>%
      mutate(model = "median") %>%
      select(all_of(names(plotDataRaw)))
  ) %>%
  mutate(model = factor(model, levels=rev(modelsOrder)))

decade_change <- plotData %>% 
  filter(model == "median", period %% 10 == 0, period > 2020) %>%
  select(period, variable, value) %>%
  arrange(variable,period) %>%
  group_by(variable) %>%
  mutate(
    change_in_10_years = value - lag(value),
    change_percentage = ((change_in_10_years) / lag(value))/10 * 100,
    prev_period = lag(period),
    prev_value = lag(value)
  ) %>%
  mutate(
    x = (period + prev_period) / 2,
    y = (value + prev_value) / 2,
    vAlign = case_when(
      TRUE ~ -1.5
    )
  )

g[["Carbon Price"]] <- ggplot(plotData,aes(x=period,y=value)) +
  geom_segment(data = plotData %>% filter(period %% 10 == 0), aes(x = period, xend = period, y = 0, yend = value), color = def$grid$color, size = def$grid$lineSize, linetype = def$grid$linetype) + # vertical grid line
  annotate("rect", xmin = -Inf, xmax = 2024, ymin = -Inf, ymax = Inf, fill = def$hist$areaColor, alpha = def$hist$alpha) + # historical area
  annotate("text", x = 2019.5, y = 600, label = "Historical", hjust = 0.5, vjust = 0.5, size = 15/.pt, color = "#888888") + # historical text
  geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
  geom_line(data=plotData %>% filter((!(model %in% c("Historical", "median")))), size=def$model$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(model != "median", period > 2023), shape = def$model$shape, aes(colour = model, shape = model), fill = "white", size = def$model$pointSize, stroke = def$model$pointStroke) +
  geom_line(data=plotData %>% filter(model == "median"), size=def$median$lineSize,aes(color=model,linetype=model, alpha = model)) + # models data
  geom_point(data = plotData %>% filter(model == "median"), shape = def$median$shape, aes(colour = model, shape = model), fill = "white", size = def$median$pointSize, stroke = def$median$pointStroke) +
  theme_paper() +
  scale_color_manual(name = "legend", values = setNames(color[levels(plotData$model)],levels(plotData$model)), guide = guide_legend(nrow = 2)) +
  scale_alpha_manual(values = modelAlpha) +
  scale_linetype_manual(values = modelLinetype) +
  scale_shape_manual(name = "legend", values = modelShape, guide = guide_legend(ncol = 1)) +
  labs(title = expression(paste("(a) Carbon Price")), subtitle = expression(paste("/t", CO[2]))) + 
  scale_x_continuous(expand = c(0, 0)) +
  coord_cartesian(clip = 'off') + 
  theme(legend.position = "bottom",
        legend.key.height = unit(1, 'cm'),
        plot.margin = margin(r = 50, l = 20),
        #legend.margin = margin(l = 50),
        strip.text = element_blank()
  ) +
  guides(alpha = "none", linetype = "none")

```


```{r Share of consumption, echo=FALSE, include=FALSE}

  plotData <- data.frame(
      model = c("IMAGE", "PROMETHEUS", "REMIND", "TIAM-ECN", "WITCH"),
      value = c(0.003, 0.005, 0.010, 0.006, 0.021)  # converted to decimals
    ) %>% 
    mutate(min = min(value),
        max = max(value))

  g[["Share of consumption"]] <- ggplot(plotData, aes(x = 0, y = value)) +
    geom_hline(yintercept=0, color = "black", linewidth= def$yAxis$linewidth, alpha = def$yAxis$alpha) + # y-axis zero
    geom_errorbar(aes(ymin=min, ymax=max), width=0.3, colour="black", alpha=0.9, linewidth=1) +
    geom_boxplot(outlier.shape = NA, width=0.3) +
    geom_point(data = plotData, shape = def$model$shape, aes(colour = model), fill = "white", size = 2, stroke = 2) +
    geom_text_repel(aes(label = model, colour = model),
      nudge_x = c(0.3,0.3,0.3,0.3,0.3),
      nudge_y = c(-0.001,-0.001,0.001,0.002,0.001),
      direction = "y",
      hjust = 0,
      segment.size = 0.6,
      segment.color = "grey30",
      size = 3
    ) +
    theme_paper() +
    scale_y_continuous(labels = scales::percent_format(accuracy = 0.1), breaks = seq(0, 0.025, by = 0.005), limits = c(0,0.025)) +
    scale_x_continuous(limits = c(-0.6, 0.6)) + #, expand = expansion(mult = 0.2)) +
    theme(
      legend.position = "none",
      axis.text.x = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.margin = margin(b = 100, r = 20),
    ) +
    labs(title = expression(paste("(b) Mitigation costs")), subtitle = "as share of consumption")

  
```


```{r figure 6, echo=FALSE, include=FALSE}

g[["Figure 6"]] <- gridExtra::arrangeGrob(
  g$`Carbon Price`,
  g$`Share of consumption`,
  layout_matrix = rbind(c(1,1,1,2))
   )

ggsave(paste0(outFolder, "/png/Figure 6 Carbon price and Share of consumption.png"), g[["Figure 6"]], device="png", width = 12, height = 6, dpi=300, units = "in")
ggsave(paste0(outFolder, "/svg/Figure 6 Carbon price and Share of consumption.svg"), g[["Figure 6"]], device="svg", width = 12, height = 6, dpi=100, units = "in")

```


```{r, echo=FALSE, fig.width=12, fig.height=6}

grid.newpage()
grid.draw(g[["Figure 6"]])

```

Figure 6. Carbon price and Share of consumption. 




