---
title: "Charts for ECEMF model comparison analysis"
output:
  html_document:
    theme: paper
    toc: true
    toc_float:
      collapsed: false
---

<style>
  .main-container {
    max-width: 95% !important;
  }
  .toc-content {
    padding-left: 0px !important;
  }
  .svg-container {
    margin: auto !important;
  }
</style>

<!-- Setting default chunk options -->
```{r chunkOptions, echo=FALSE, include = FALSE}
  knitr::opts_chunk$set(dev='svglite', # svg, png,...
                        fig.ext = ".svg",
                        #fig.asp = .8 # default aspect ratio
                        fig.width = 12,
                        fig.height = 8,
                        dpi=100
                        )
```  


```{r loading_packages, echo=FALSE, include = FALSE}

  #Loading required packages
  packagesList <- c("reticulate", "tidyr", "dplyr", "quitte", "openxlsx", "piamInterfaces", "ggplot2")
  #packagesList <- c("quitte","ggplot2","geomtextpath","ggpattern","tidyr","grid","stringr","gridExtra","ggrepel","kableExtra","dplyr","remind2","rsvg","ggsvg")
  packages <- suppressWarnings(suppressMessages(lapply(packagesList, function(x){ if(!require(x, character.only = T, quietly = T)){ install.packages(x); return(paste0("installed missing package: ", x)) } else paste0("required package is installed: ", x) } )))

```

## download and prepare data

```{r download_data, echo=FALSE, include = FALSE}

  downloadData <- FALSE
  
  #to set credentials for accessing the ECEMF Scenario Explorer database please run the following script once in a Python console:
  #import pyam
  #pyam.iiasa.set_config("<username>", "<password>")
  #Refer to this [tutorial](https://pyam-iamc.readthedocs.io/en/stable/tutorials/iiasa_dbs.html) for more information!
  
  dir.create("./data", recursive = TRUE, showWarnings = FALSE)

  if(downloadData || length(list.dirs(path = "./data", full.names = TRUE, recursive = FALSE)) == 0){
    
    time <- format(Sys.time(), "%Y_%m_%d_%H.%M.%S")
    dataPath <- paste0("./data/", time)
    dir.create(dataPath, recursive = TRUE, showWarnings = FALSE)
    
    source_python("./download_iiasa_db.py")
    
    # Downloading metadata
    print(paste0("Downloading metadata."))
    download_iiasa_meta_py(fileName = paste0(dataPath, "/metadata_",time), db="ecemf_internal", default_only = TRUE)
  
    # Downloading data
    print(paste0("Downloading data"))  
    scenList <- c("WP1 NPI", "WP1 NetZero", "WP1 NetZero-LimBio", "WP1 NetZero-LimCCS", "WP1 NetZero-LimNuc", "WP1 NetZero-ElecPush", "WP1 NetZero-H2Push", "WP1 NetZero-SynfPush", "WP1 NetZero-HighEfficiency")
    download_iiasa_db_py(fileName = paste0(dataPath, "/WP1_allModels_" ,time), db="ecemf_internal", model="*", 
                         scen=scenList, 
                         region=c("EU27 & UK (*)", "EU27 (*)"))
    
    # Filtering downloaded data to retain only most up to date results 
    
      #auxiliary function to simplify model name
      simplifyModelName <- function(model){
        model <- gsub("v\\d*\\.?\\d*\\.?\\d*", "", model) # remove "v1.0.0"
        model <- gsub(" \\d*\\.?\\d*\\.?\\d*", "", model) # remove "1.0.0"
        model <- gsub(" \\d*\\.?\\d*", "", model) # remove "1.1"
        model <- gsub("\\s$*", "", model) # remove trailing spaces
        model <- gsub("\\_*$", "", model) # remove trailing underscores
        model <- gsub("MESSAGEix-GLOBIOM","MESSAGE",model)
        return(model)
      }
      
      # table to filter most up to date results  
      metaFilter <- openxlsx::read.xlsx(paste0(dataPath, "/metadata_", time,".xlsx")) %>%
        tidyr::fill(model, .direction = "down") %>% # fill NAs with above row values
        arrange(desc(create_date)) %>%
        mutate(cleanModelName = simplifyModelName(model)) %>%
        group_by(cleanModelName,scenario) %>% 
        filter(row_number()==1) %>%
        ungroup()
    
      # cleaning data from NAs, formatting issues, filtering only more recent data, and simplifying model names
      data <- read.xlsx(paste0(dataPath, "/WP1_allModels_" , time ,".xlsx")) %>% 
        as.quitte() %>% 
        filter(!is.na(value)) %>%  
        mutate(region = gsub("&amp;", "&", region)) %>% 
        right_join(metaFilter %>% filter(scenario %in% scenList) %>% select(model,scenario), by = join_by(model, scenario)) %>%
        mutate(model = simplifyModelName(model)) %>%
        na.omit()
    
    write.xlsx(data %>% pivot_wider(names_from = period, values_from = value) %>% select(where(~!all(is.na(.x)))), file = paste0(dataPath, "/WP1_" , time,".xlsx"))
  
  }

```
  
  
```{r load_data, echo=FALSE, include = FALSE}
  
  # select data file
  dataFolder <- sort(list.dirs(path = "./data", full.names = TRUE, recursive = FALSE), decreasing = T)[1]
  time <- basename(dataFolder)
  
  dataFile <- paste0("./data/", time, "/WP1_", time, ".xlsx")
  
  df <- suppressWarnings(quitte::read.quitte(dataFile)) %>% 
        filter(!is.na(value))
  
```  
  

```{r ,load_historical_mif, echo=FALSE, include = FALSE}

 if(file.exists("./hist/historical.rds")){
      hist <- readRDS("./hist/historical.rds")
 } else {
   # data directly from the historical mif
   hist <- piamInterfaces::convertHistoricalData(
     mif = "./hist/historical.mif",
     project = "ECEMF",
     regionMapping = "./hist/regionmapping_historical.csv"
   )
   saveRDS(hist,"./hist/historical.rds")
 }

 if(file.exists("./hist/historical_origName.rds")){
      histOrigN <- readRDS("./hist/historical_origName.rds")
 } else {
   # data directly from the historical mif
   histOrigN <- suppressWarnings(quitte::read.quitte("./hist/historical.mif")) %>% 
        filter(!is.na(value) )
   histOrigN <- filter(histOrigN, period >= 1990)
   saveRDS(histOrigN,"./hist/historical_origName.rds")
 }

```  



```{r create_charts, echo=FALSE, include=FALSE}

  # creating charts
  g <- NULL

  # output folder
  dir.create(paste0("./output/", time, "/svg"), recursive = TRUE, showWarnings = FALSE)
  dir.create(paste0("./output/", time, "/png"), recursive = TRUE, showWarnings = FALSE)

``` 


```{r aesthetics, echo=FALSE, include=FALSE}

color <- c(
  #model
  "IMAGE" = "#00ffff",
  "Euro-Calliope" = "#c0c0c0",
  "MEESA" = "#ff00ff",
  "x MEESA" = "#ff00ff",
  "MESSAGE" = "#800080",
  "OSeMBE" = "#a52a2a",
  "x OSeMBE" = "#a52a2a",
  "PRIMES" = "#0000ff",
  "PROMETHEUS" = "#ffd900",
  "REMIND" = "#ff6347",
  "LIMES" = "#ffaf47",
  "TIAM-ECN" = "#4682b4",
  "WITCH" = "#228b22"
)

modelLinetype <- c(
  "IMAGE" =       "solid" ,
  "Euro-Calliope" = "dashed",
  "MEESA" =      "solid",
  "x MEESA" =    "solid",
  "MESSAGE" =    "dashed",
  "OSeMBE" =     "solid",
  "x OSeMBE" =   "solid",
  "PRIMES" =     "solid",
  "PROMETHEUS" = "solid",
  "REMIND" =     "solid",
  "LIMES" =      "solid",
  "TIAM-ECN" =   "solid",
  "WITCH" =      "solid"
)

``` 


# Emissions {.tabset}

## calculate additional variables
```{r calculate_nonCO2, echo=FALSE, include = FALSE}
df <- calc_addVariable(df, "`Emi|Kyoto Gases|non-CO2 calc`" = "`Emissions|Kyoto Gases|non-CO2`", units = "MtCO2e/yr")
df <- calc_addVariable(df, "`Emi|Kyoto Gases|non-CO2 calc`" = "`Emissions|Kyoto Gases` - `Emissions|CO2`", units = "MtCO2e/yr")
df <- calc_addVariable(df, "`Emi|Kyoto Gases|non-CO2 DiffRepTocalc`" = "`Emissions|Kyoto Gases|non-CO2` - `Emi|Kyoto Gases|non-CO2 calc`", units = "MtCO2e/yr")
```

## GHG Emissions

```{r ghg_emissions, echo=FALSE, include=FALSE}

  plotData <- df %>%
    filter(variable == "Emissions|Kyoto Gases",
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
#           scenario %in% c("WP1 NPI", "WP1 NetZero", "WP1 NetZero-LimBio", "WP1 NetZero-LimCCS", "WP1 NetZero-LimNuc"),
           region == "EU27 & UK (*)")
#           region %in% c("EU27 & UK (*)","EUR"))

  histData <- hist %>%
    filter(variable == "Emissions|Kyoto Gases",
           region == "EU27 & UK (*)",
           model == "Eurostat")
  
  histDataOrigN <- histOrigN %>%
    filter(variable == "Emi|GHG|w/ Bunkers",
           region == "EUR",
           model == "UNFCCC")
  
  g[["GHG_Emissions"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=model)) +
      geom_line(data=histDataOrigN, size=3,linetype="solid", color = "black") +
      geom_line(data=histData, size=3,linetype="solid", color = "red") +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = modelLinetype) +
#      scale_linetype_manual(values = c("WP1 NetZero"="solid")) +
#      scale_linetype_manual(values = c("historical"="solid","WP1 NPI"="solid", "WP1 NetZero"="dashed", "WP1 NetZero-LimBio"="dotted", "WP1 NetZero-LimCCS"="dotdash", "WP1 NetZero-LimNuc"="longdash")) +
      ggtitle("GHG Emissions") +
      ylab(expression(paste("Mt ", CO[2],"eq/yr"))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/svg/GHG_Emissions.svg"), g[["GHG_Emissions"]] , device="svg", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/GHG_Emissions.png"), g[["GHG_Emissions"]] , device="png", width = 12, height = 8, dpi=100, units = "in")

```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["GHG_Emissions"]]
```


## GHG Emissions reductions vs 2020

```{r ghg_emissions_reductions_vs_2020, echo=FALSE, include=FALSE}


  plotData <- left_join(
      df %>%
        filter(variable == "Emissions|Kyoto Gases",
               period %in% c(2030,2040,2050),
               scenario == "WP1 NetZero",
               region == "EU27 & UK (*)") %>%
        mutate(numerator=value)
      ,
      df %>%
        filter(variable == "Emissions|Kyoto Gases",
               period == 2020,
               scenario == "WP1 NetZero",
               region == "EU27 & UK (*)") %>%
        mutate(denominator=value) %>%
        select(model,denominator)
      , by = join_by(model == model)
      ) %>%
    mutate(percentage = numerator/denominator,
           reduction = 1-percentage) %>%
    na.omit()

  g[["GHG_Emissions_Reductions_vs_2020"]] <-  ggplot(plotData,aes(x=model,y=reduction,fill=variable)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_bar(stat='identity', alpha = 0.8) +
    facet_wrap(~period,nrow=1) +
    theme_minimal(base_size = 24) +
    scale_fill_manual(values = "#cccccc") +
    ylab("GHG Emissions Reductions vs 2020 (%)") +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2)) +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5)) +
    theme(axis.title.x=element_blank()) +
    theme(legend.position="none",
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/svg/GHG_Emissions_Reductions_vs_2020.svg"), g[["GHG_Emissions_Reductions_vs_2020"]] , device="svg", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/GHG_Emissions_Reductions_vs_2020.png"), g[["GHG_Emissions_Reductions_vs_2020"]] , device="png", width = 12, height = 8, dpi=100, units = "in")

```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["GHG_Emissions_Reductions_vs_2020"]]
```

## GHG Emissions reductions vs 1990 - range

```{r ghg_emissions_reductions_vs_2020_range, echo=FALSE, include=FALSE}

#PRIMES is not reporting Emissions|Kyoto Gases

models_without_data <- df %>%
    filter(variable == "Emissions|Kyoto Gases",
           period >= 2010, period <= 2050,
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    group_by(model) %>%
    filter(sum(value*value) == 0) %>%
    pull(model) %>%
    unique()

if(length(models_without_data) > 0)
  warning(paste0("Models that do not report `Emissions|Kyoto Gases` and that are excluded from this chart: ", models_without_data))

  plotData <- df %>%
    filter(variable == "Emissions|Kyoto Gases",
           period >= 2010, period <= 2050,
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)", 
           !(model %in% models_without_data)) %>%
    mutate(denominator= histOrigN %>% filter(region == "EUR", model == "UNFCCC", variable == "Emi|GHG", period == "1990") %>% pull(value),
           numerator=value) %>%
    mutate(percentage = numerator/denominator,
           reduction = 1-percentage) %>%
    na.omit() %>%
    group_by(period) %>%
    summarise_at(vars(reduction), list(
      Min = min,
      Mean = mean,
      Median = median,
      Max = max,
      Sd = sd,
      Q1=~quantile(., probs = 0.25),
      Q3=~quantile(., probs = 0.75)))

  g[["GHG_Emissions_Reductions_vs_1990_range"]] <- 
    ggplot(plotData,aes(x=period,y=Median)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
    geom_line(linewidth=1,color="black") +
    geom_ribbon(aes(ymax = Q3, ymin = Q1), alpha = 0.5, fill = "#545454") +
    geom_line(aes(y=Min),linewidth=1,color="#545454",linetype = "dashed", alpha = 0.7) +
    geom_line(aes(y=Max),linewidth=1,color="#545454",linetype = "dashed", alpha = 0.7) +
    #geom_line(data=h,linewidth=1,aes(linetype=Source)) +
    #geom_point() +
    theme_minimal(base_size = 24) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    theme(axis.title.x=element_blank()) +
    theme(legend.position="none",
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA)) +
    ylab("GHG Emissions Reductions vs 1990 (%)")
  

  ggsave(paste0("./output/", time, "/svg/GHG_Emissions_Reductions_vs_1990_range.svg"), g[["GHG_Emissions_Reductions_vs_1990_range"]] , device="svg", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/GHG_Emissions_Reductions_vs_1990_range.png"), g[["GHG_Emissions_Reductions_vs_1990_range"]] , device="png", width = 12, height = 8, dpi=100, units = "in")

```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["GHG_Emissions_Reductions_vs_1990_range"]]
```

## CO2 Emissions

```{r CO2_Emi_EnergyIndustrProc, echo=FALSE, include=FALSE}

  plotData <- df %>%
    filter(variable == "Emissions|CO2|Energy and Industrial Processes",
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
#           scenario %in% c("WP1 NPI", "WP1 NetZero", "WP1 NetZero-LimBio", "WP1 NetZero-LimCCS", "WP1 NetZero-LimNuc"),
           region == "EU27 & UK (*)")
#           region %in% c("EU27 & UK (*)","EUR"))

  histDataOrigN <- histOrigN %>%
    filter(variable == "Emi|CO2|w/ Bunkers|Energy and Industrial Processes",
           region == "EUR",
           model == "UNFCCC")
  
  g[["CO2_Emi_EnergyIndustrProc"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=model)) +
      geom_line(data=histDataOrigN, size=3,linetype="solid", color = "black") +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = modelLinetype) +
#      scale_linetype_manual(values = c("WP1 NetZero"="solid")) +
      ggtitle("CO2 Emissions - energy and industrial processes") +
      ylab(expression(paste("Mt ", CO[2],"eq/yr"))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/CO2_Emi_EnergyIndustrProc.png"), g[["CO2_Emi_EnergyIndustrProc"]] , device="png", width = 12, height = 8, dpi=100, units = "in")

```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["CO2_Emi_EnergyIndustrProc"]]
```

## Power sector emissions

```{r CO2_electricitySupply, echo=FALSE, include=FALSE}

  plotData <- df %>%
    filter(variable == "Emissions|CO2|Energy|Supply|Electricity",
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
#           scenario %in% c("WP1 NPI", "WP1 NetZero", "WP1 NetZero-LimBio", "WP1 NetZero-LimCCS", "WP1 NetZero-LimNuc"),
           region == "EU27 & UK (*)")
#           region %in% c("EU27 & UK (*)","EUR"))
  
  histDataOrigN <- histOrigN %>%
    filter(variable == "Emi|CO2|Energy|Supply|Electricity w/ couple prod",
           region == "EUR",
           model == "Ember")
  
  g[["CO2_electricitySupply"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=model)) +
      geom_line(data=histDataOrigN, size=3,linetype="solid", color = "black") +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = modelLinetype) +
#      scale_linetype_manual(values = c("historical"="solid","WP1 NPI"="solid", "WP1 NetZero"="solid", "WP1 NetZero-LimBio"="dotted", "WP1 NetZero-LimCCS"="dotdash", "WP1 NetZero-LimNuc"="longdash")) +
      ggtitle("Electricity Supply CO2 emissions") +
      ylab(expression(paste("Mt ", CO[2]))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/svg/CO2_Emissions_Electricity.svg"), g[["CO2_electricitySupply"]] , device="svg", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/CO2_Emissions_Electricity.png"), g[["CO2_electricitySupply"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["CO2_electricitySupply"]]
```

## Power sector emissions - fewer models

```{r CO2_electricitySupply_filtered, echo=FALSE, include=FALSE}

  plotData <- df %>%
    filter(variable == "Emissions|CO2|Energy|Supply|Electricity",
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
           model %in% c("IMAGE","MEESA","PRIMES","PROMETHEUS","REMIND"),
#           scenario %in% c("WP1 NPI", "WP1 NetZero", "WP1 NetZero-LimBio", "WP1 NetZero-LimCCS", "WP1 NetZero-LimNuc"),
           region == "EU27 & UK (*)")
#           region %in% c("EU27 & UK (*)","EUR"))
  
  histDataOrigN <- histOrigN %>%
    filter(variable == "Emi|CO2|Energy|Supply|Electricity w/ couple prod",
           region == "EUR",
           model == "Ember")
  
  g[["CO2_electricitySupplyFewerModels"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(linetype=model, color = "grey")) +
      geom_line(data=histDataOrigN, size=3,linetype="solid", color = "black") +
#      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
#      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = modelLinetype) +
#      scale_linetype_manual(values = c("historical"="solid","WP1 NPI"="solid", "WP1 NetZero"="solid", "WP1 NetZero-LimBio"="dotted", "WP1 NetZero-LimCCS"="dotdash", "WP1 NetZero-LimNuc"="longdash")) +
      ggtitle("Electricity Supply CO2 emissions") +
      ylab(expression(paste("Mt ", CO[2]))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/svg/CO2_electricitySupplyFewerModels.svg"), g[["CO2_electricitySupplyFewerModels"]] , device="svg", width = 18, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/CO2_electricitySupplyFewerModels.png"), g[["CO2_electricitySupplyFewerModels"]] , device="png", width = 18, height = 8, dpi=100, units = "in")
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["CO2_electricitySupplyFewerModels"]]
```

## CDR

```{r CDR, echo=FALSE, include=FALSE}

  plotData <- df %>%
    filter(variable %in% c("Carbon Removal","Carbon Removal|Land Use","Carbon Removal|Geological Storage"),
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
           region == "EU27 & UK (*)")

  histPlotDataOrigN <- histOrigN %>%
    filter(variable == "Emi|CO2|Land-Use Change",
           region == "EUR",
           model == "UNFCCC") %>%
    mutate(value = -1 * value)

  g[["CDR_line"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=variable)) +
      geom_line(data=histPlotDataOrigN, size=3,linetype="solid", color = "black") +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = c("Carbon Removal"="solid", "Carbon Removal|Land Use"="dashed", "Carbon Removal|Geological Storage"="dotted")) +
      ggtitle("Carbon Dioxide Removal") +
      ylab(expression(paste("Mt ", CO[2],"e"))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/CDR_line.png"), g[["CDR_line"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["CDR_line"]]
```

## Carbon Capture

### Carbon Capture line plot
```{r CC_line, echo=FALSE, include=FALSE}

  plotData <- df %>%
    filter(variable %in% c("Carbon Capture", "Carbon Capture|Biomass", "Carbon Capture|Fossil", "Carbon Capture|Direct Air Capture", "Carbon Capture|Industrial Process"),
           variable %in% c("Carbon Capture"),
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
           model %in% c("IMAGE","MEESA","MESSAGE","OSEMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           region == "EU27 & UK (*)")

  g[["CC_line"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=variable)) +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = c("Carbon Capture"="solid", "Carbon Capture|Biomass"="dashed", "Carbon Capture|Fossil"="dotted", "Carbon Capture|Direct Air Capture"="dotdash", "Carbon Capture|Industrial Process"="longdash")) +
      ggtitle("Carbon Capture") +
      ylab(expression(paste("Mt ", CO[2],"/yr"))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/CC_line.png"), g[["CC_line"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
    quantile(filter(plotData, period == 2030)[["value"]], c(0, 0.25, 0.5, 0.75, 1)) # give out interquartiles    
    quantile(filter(plotData, period == 2040)[["value"]], c(0, 0.25, 0.5, 0.75, 1)) # give out interquartiles     
    quantile(filter(plotData, period == 2050)[["value"]], c(0, 0.25, 0.5, 0.75, 1)) # give out interquartiles 
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["CC_line"]]
```

### CCarbon Capture origin stacked bar
```{r, echo=FALSE, include=FALSE}

vars <- c(
  "Direct Air Capture"="Carbon Capture|Direct Air Capture", 
  "Biomass"="Carbon Capture|Biomass",
  "Fossil" = "Carbon Capture|Fossil",
  "Industrial Process"="Carbon Capture|Industrial Processes")

carrier_color <- c(  
  "Direct Air Capture" = "#5ed5f0",
  "Industrial Process" = "#bf960d",
  "Biomass" = "#005900",
  "Fossil" = "#0c0c0c")

  plotData <- df %>%
    filter(variable %in% vars,
           period %in% c(2030,2040,2050),
           scenario == "WP1 NetZero",
           model %in% c("IMAGE","MEESA","MESSAGE","OSeMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           region == "EU27 & UK (*)") %>%
    mutate(value = value * 1, # EJ
           model = factor(model, levels = c("LIMES", "Euro-Calliope","IMAGE","MEESA","MESSAGE","OSeMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH")),
           variable = factor(variable, levels = vars)) #order
  
  g[["CC_origin_StBar"]] <- ggplot(plotData,aes(x=model,y=value,fill=variable)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_bar(stat='identity', alpha = 0.8) +
#    coord_cartesian(ylim = c(0, 120)) +
    facet_wrap(~period,nrow=1) +
    theme_minimal(base_size = 24) +
    scale_fill_manual(values = setNames(carrier_color[names(vars)],vars), labels = setNames(names(vars), vars)) +
    ggtitle("CC by origin") +
    ylab("Mt CO2/yr") +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5),
          axis.title.x=element_blank(),
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/CC_origin_StBar.png"), g[["CC_origin_StBar"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["CC_origin_StBar"]]
```

## non-CO2 Emissions

```{r nonCO2_emissions, echo=FALSE, include=FALSE}

  plotData <- df %>%
    filter(variable == "Emi|Kyoto Gases|non-CO2 calc",
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
           model %in% c("IMAGE","MESSAGE","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           region == "EU27 & UK (*)")

#  histDataOrigN <- histOrigN %>%
#    filter(variable == "Emi|GHG|w/ Bunkers",
#           region == "EUR",
#           model == "UNFCCC")
  
  g[["Emi_nonCO2_line"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=model)) +
#      geom_line(data=histDataOrigN, size=3,linetype="solid", color = "black") +
      geom_line(data=histData, size=3,linetype="solid", color = "red") +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = modelLinetype) +
#      scale_linetype_manual(values = c("historical"="solid","WP1 NPI"="solid", "WP1 NetZero"="solid")) +
      ggtitle("non-CO2 Emissions") +
      ylab(expression(paste("Mt ", CO[2],"eq/yr"))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/Emi_nonCO2_line.png"), g[["Emi_nonCO2_line"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["Emi_nonCO2_line"]]
```

# Carbon prices {.tabset}
## Carbon price line plot
```{r CarbonPrice_line, echo=FALSE, include=FALSE}

  plotData <- df %>%
    filter(variable == "Price|Carbon",
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
           model %in% c("IMAGE","MEESA","OSEMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           region == "EU27 & UK (*)")

  g[["CarbonPrice_line"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      coord_cartesian(ylim = c(0, 1200)) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=model)) +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = modelLinetype) +
#     scale_linetype_manual(values = c("historical"="solid","WP1 NPI"="solid", "WP1 NetZero"="solid")) +
      ggtitle("Carbon Price") +
      ylab(expression(paste("EUR/tCO2"))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/CarbonPrice_line.png"), g[["CarbonPrice_line"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
    quantile(filter(plotData, period == 2030)[["value"]], c(0, 0.25, 0.5, 0.75, 1)) # give out interquartiles    
    quantile(filter(plotData, period == 2040)[["value"]], c(0, 0.25, 0.5, 0.75, 1)) # give out interquartiles     
    quantile(filter(plotData, period == 2050)[["value"]], c(0, 0.25, 0.5, 0.75, 1)) # give out interquartiles 
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["CarbonPrice_line"]]
```

# Shares {.tabset}

## calculate additional variables 
```{r calculate_Elecshares, echo=FALSE, include = FALSE}

  df <- calc_addVariable(df, "`Final Energy|Electricity Share`" = "`Final Energy|Electricity` / `Final Energy`", units = "%")
  df <- calc_addVariable(df, "`Final Energy|Electricity Share woBunkers woNonEnergy`" = "(`Final Energy|Electricity` - `Final Energy|Bunkers|Electricity`) / (`Final Energy` - `Final Energy|Bunkers` - `Final Energy|Non-Energy Use`)", units = "%", completeMissing = TRUE)
  
#forRunning  histOrigN <- calc_addVariable(histOrigN, "`Final Energy|Electricity Share woBunkers woNonEnergy`" = "(`FE|Electricity`) / (`FE` - `FE|Transport|Bunkers` - `FE|Non-energy Use|Industry`)", units = "%", completeMissing = TRUE)
#forRunning  histOrigN <- calc_addVariable(histOrigN, "`Final Energy|Electricity Share`" = "`FE|Electricity` / `FE`", units = "%", completeMissing = TRUE)
  
  df <- calc_addVariable(df, "`Final Energy|Industry|Electricity Share`" = "`Final Energy|Industry|Electricity` / `Final Energy|Industry`", units = "%")
  df <- calc_addVariable(df, "`Final Energy|Residential and Commercial|Electricity Share`" = "`Final Energy|Residential and Commercial|Electricity` / `Final Energy|Residential and Commercial`", units = "%")
  df <- calc_addVariable(df, "`Final Energy|Transportation|Electricity Share`" = "`Final Energy|Transportation|Electricity` / `Final Energy|Transportation`", units = "%")
  
    df <- calc_addVariable(df, "`Final Energy|Nonelectric`" = "`Final Energy` - `Final Energy|Electricity`", units = "%")
#    df <- calc_addVariable(df, "`UE|Nonelectric`" = "`Final Energy|Nonelectric`", units = "%")     
#    df <- calc_addVariable(df, "`UE|Nonelectric`" = "`Final Energy|Nonelectric`", units = "%") 

```

```{r calculate_H2hares, echo=FALSE, include = FALSE}
  df <- calc_addVariable(df, "`Final Energy|Hydrogen Share`" = "`Final Energy|Hydrogen` / `Final Energy`", units = "%")
  df <- calc_addVariable(df, "`Final Energy|Hydrogen Share woBunkers woNonEnergy`" = "(`Final Energy|Hydrogen` - `Final Energy|Bunkers|Hydrogen` - `Final Energy|Non-Energy Use|Hydrogen`) / (`Final Energy` - `Final Energy|Bunkers` - `Final Energy|Non-Energy Use`)", units = "%", completeMissing = TRUE)
  
  df <- calc_addVariable(df, "`Final Energy|Industry|Hydrogen Share`" = "`Final Energy|Industry|Hydrogen` / `Final Energy|Industry`", units = "%")
  df <- calc_addVariable(df, "`Final Energy|Residential and Commercial|Hydrogen Share`" = "`Final Energy|Residential and Commercial|Hydrogen` / `Final Energy|Residential and Commercial`", units = "%")
  df <- calc_addVariable(df, "`Final Energy|Transportation|Hydrogen Share`" = "`Final Energy|Transportation|Hydrogen` / `Final Energy|Transportation`", units = "%")
```

```{r calculate_SEshares, echo=FALSE, include = FALSE}

  if("Trade|Secondary Energy|Liquids|Electricity|Volume" %in% unique(df$variable))
    df <- calc_addVariable(df, "`SE-Import|Liquids|Synfuel`" = " -`Trade|Secondary Energy|Liquids|Electricity|Volume`", units = "EJ/yr")
  df <- calc_addVariable(df, "`SE-Import|Liquids|Fossil`" = " -`Trade|Secondary Energy|Liquids|Oil|Volume` - `Trade|Secondary Energy|Liquids|Coal|Volume` - `Trade|Secondary Energy|Liquids|Gas|Volume`", units = "EJ/yr")
  df <- calc_addVariable(df, "`SE-Import|Liquids|Bio`" = " -`Trade|Secondary Energy|Liquids|Biomass|Volume` ", units = "EJ/yr")
  
  df <- calc_addVariable(df, "`SE|Liquids|Bio Share`" = "`Secondary Energy|Liquids|Biomass` / `Secondary Energy|Liquids`", units = "%", completeMissing = TRUE)
  df <- calc_addVariable(df, "`SE|Liquids|Synfuel Share`" = "`Secondary Energy|Liquids|Electricity` / `Secondary Energy|Liquids`", units = "%", completeMissing = TRUE)
  df <- calc_addVariable(df, "`SE|Liquids|Fossil Share`" = "`Secondary Energy|Liquids|Fossil` / `Secondary Energy|Liquids`", units = "%", completeMissing = TRUE)
  
  df <- calc_addVariable(df, "`SE|Liquids|SumOfShares`" = "`SE|Liquids|Fossil Share` + `SE|Liquids|Bio Share` + `SE|Liquids|Synfuel Share`", units = "%", completeMissing = TRUE)
    
  df <- calc_addVariable(df, "`SE|Gases|Bio Share`" = "`Secondary Energy|Gases|Biomass` / `Secondary Energy|Gases`", units = "%", completeMissing = TRUE)
  df <- calc_addVariable(df, "`SE|Gases|Synfuel Share`" = "`Secondary Energy|Gases|Electricity` / `Secondary Energy|Gases`", units = "%", completeMissing = TRUE)
  df <- calc_addVariable(df, "`SE|Gases|Fossil Share`" = "`Secondary Energy|Gases|Fossil` / `Secondary Energy|Gases`", units = "%", completeMissing = TRUE)
  df <- calc_addVariable(df, "`SE|Gases|SumOfShares`" = "`SE|Gases|Fossil Share` + `SE|Gases|Bio Share` + `SE|Gases|Synfuel Share`", units = "%", completeMissing = TRUE)
   
  df <- calc_addVariable(df, "`SE|Solids|Bio Share`" = "`Secondary Energy|Solids|Biomass` / `Secondary Energy|Solids`", units = "%", completeMissing = TRUE)
  df <- calc_addVariable(df, "`SE|Solids|Coal Share`" = "`Secondary Energy|Solids|Coal` / `Secondary Energy|Solids`", units = "%", completeMissing = TRUE)
  df <- calc_addVariable(df, "`SE|Solids|Fossil Share`" = "`Secondary Energy|Solids|Fossil` / `Secondary Energy|Solids`", units = "%", completeMissing = TRUE)
  df <- calc_addVariable(df, "`SE|Solids|SumOfShares`" = "`SE|Solids|Fossil Share` + `SE|Solids|Bio Share`", units = "%", completeMissing = TRUE)
```

```{r calculate_SEshares_2, echo=FALSE, include = FALSE}
df <- calc_addVariable(df, "`SE|SolLiqGas`" = "`Secondary Energy|Liquids` + `Secondary Energy|Solids` + `Secondary Energy|Gases`", units = "%")
df <- calc_addVariable(df, "`SE|SolLiqGas|Bio`" = "`Secondary Energy|Liquids|Biomass` + `Secondary Energy|Solids|Biomass` + `Secondary Energy|Gases|Biomass`", units = "%", completeMissing = TRUE)
df <- calc_addVariable(df, "`SE|SolLiqGas|Fossil`" = "`Secondary Energy|Liquids|Fossil` + `Secondary Energy|Solids|Fossil` + `Secondary Energy|Gases|Fossil`", units = "%", completeMissing = TRUE)
df <- calc_addVariable(df, "`SE|SolLiqGas|Synfuel`" = "`Secondary Energy|Liquids|Electricity` +  `Secondary Energy|Gases|Electricity`", units = "%", completeMissing = TRUE)


df <- calc_addVariable(df, "`SE|SolLiqGas|Synfuel Share`" = "`SE|SolLiqGas|Synfuel` / `SE|SolLiqGas`", units = "%", completeMissing = TRUE)
df <- calc_addVariable(df, "`SE|SolLiqGas|Fossil Share`" = "`SE|SolLiqGas|Fossil` / `SE|SolLiqGas`", units = "%", completeMissing = TRUE)
df <- calc_addVariable(df, "`SE|SolLiqGas|Bio Share`" = "`SE|SolLiqGas|Bio` / `SE|SolLiqGas`", units = "%", completeMissing = TRUE)
df <- calc_addVariable(df, "`SE|SolLiqGas|SumOfShares`" = "`SE|SolLiqGas|Fossil Share` + `SE|SolLiqGas|Bio Share` + `SE|SolLiqGas|Synfuel Share`", units = "%", completeMissing = TRUE)
```



## Final Energy Sector Stacked Bars

```{r, echo=FALSE, include=FALSE}

vars <- c(
  "Bunkers"="Final Energy|Bunkers",
  "Transport" = "Final Energy|Transportation",
  "Res and Com"="Final Energy|Residential and Commercial",
  "Feedstock"="Final Energy|Non-Energy Use",
  "Industry"="Final Energy|Industry")

carrier_color <- c(  
  "Bunkers" = "#5ed5f0",
  "Transport" = "#005900",
  "Res and Com" = "#0c0c0c",
  "Feedstock" = "#e51900",
  "Industry" = "#999959")

  plotData <- df %>%
    filter(variable %in% vars,
           period %in% c(2020,2030,2040,2050),
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(value = value * 1, # EJ 2 TWh
           model = factor(model, levels = c("LIMES", "Euro-Calliope","IMAGE","MEESA","MESSAGE","OSeMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH")),
           variable = factor(variable, levels = vars)) #order
  
  g[["FEsector_NZero"]] <- ggplot(plotData,aes(x=model,y=value,fill=variable)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_bar(stat='identity', alpha = 0.8) +
    facet_wrap(~period,nrow=1) +
    theme_minimal(base_size = 24) +
    scale_fill_manual(values = setNames(carrier_color[names(vars)],vars), labels = setNames(names(vars), vars)) +
    ggtitle("Final Energy by sector") +
    ylab("TWh") +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5),
          axis.title.x=element_blank(),
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/FEsector_NZero.png"), g[["FEsector_NZero"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  
```


```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["FEsector_NZero"]]
```

****************************


## Final Energy Electricity shares - all sectors in four facets

```{r Final_Energy_Electricity_Share, echo=FALSE, include=FALSE}
  vars <- list(
    "Total"=c(      "Final Energy|Electricity Share"    ),
    "Industry"=c(      "Final Energy|Industry|Electricity Share"    ),
    "Buildings"=c(      "Final Energy|Residential and Commercial|Electricity Share"    ),
    "Transport"=c(      "Final Energy|Transportation|Electricity Share"    )
  )
  
  varTosector <- setNames(names(unlist(vars)),unlist(vars))
  
  plotData <- df %>%
    filter(variable %in% names(varTosector),
           period >=2005, period <= 2050,
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(sector = factor(varTosector[as.character(variable)]))
                           #, labels=c("Total","Industry","Buildings","Transport")))

  g[["Final_Energy_Electricity_Share"]] <- ggplot(plotData,aes(x=period,y=value)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
    geom_line(size=1,aes(color=model, linetype=model)) +
    geom_point(aes(color=model)) +
    theme_minimal(base_size = 24) +
    facet_wrap(~sector) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2), limits = c(0,1)) +
    scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
    scale_linetype_manual(values = modelLinetype) +
    ylab("Final Energy Electricity shares (%)") +
    theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/svg/Final_Energy_Electricity_Share.svg"), g[["Final_Energy_Electricity_Share"]] , device="svg", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/Final_Energy_Electricity_Share.png"), g[["Final_Energy_Electricity_Share"]] , device="png", width = 12, height = 8, dpi=100, units = "in")

```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["Final_Energy_Electricity_Share"]]
```
## Final Energy Electricity shares - one plot per sector

```{r Final_Energy_Electricity_Share_Total, echo=FALSE, include=FALSE}
  
  plotData <- df %>%
    filter(variable == "Final Energy|Electricity Share",
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
           region == "EU27 & UK (*)")

   g[["Final_Energy_Electricity_Share_Total"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=scenario)) +
#      geom_line(data=histDataOrigN, size=3,linetype="solid", color = "black") +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2), limits = c(0,1)) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = c("historical"="solid","WP1 NPI"="solid", "WP1 NetZero"="solid")) +
      ggtitle("Final Energy Electricity shares (%)") +
      ylab(expression(paste("(%)"))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/svg/Final_Energy_Electricity_Share_Total.svg"), g[["Final_Energy_Electricity_Share_Total"]] , device="svg", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/Final_Energy_Electricity_Share_Total.png"), g[["Final_Energy_Electricity_Share_Total"]] , device="png", width = 12, height = 8, dpi=100, units = "in")

```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["Final_Energy_Electricity_Share_Total"]]
```
## Final Energy Electricity share total woBunker wo NonEnergy

```{r Final_Energy_Electricity_Share_Total_woBunkwoNonEn, echo=FALSE, include=FALSE}
  
  plotData <- df %>%
    filter(variable == "Final Energy|Electricity Share woBunkers woNonEnergy",
           period >=2005, period <= 2050,
           model %in% c("IMAGE","MESSAGE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           scenario %in% c("WP1 NetZero"),
           region == "EU27 & UK (*)")

  plotDataHist <- histOrigN %>%
    filter(variable == "Final Energy|Electricity Share woBunkers woNonEnergy",
           period >=2005, period <= 2050,
           model == "Eurostat energy_sheets",
           scenario %in% c("historical"),
           region == "EUR")

   g[["Final_Energy_Electricity_Share_Total_woBunkwoNonEn"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=model)) +
 #     geom_line(data=plotDataHist, size=3,linetype="solid", color = "black") +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2), limits = c(0,1)) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = modelLinetype) +
#      scale_linetype_manual(values = c("historical"="solid","WP1 NPI"="solid", "WP1 NetZero"="solid")) +
      ggtitle("Share of Electricity in Final Energy Use (%)") +
      ylab(expression(paste("(%)"))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/svg/Final_Energy_Electricity_Share_Total_woBunkwoNonEn.svg"), g[["Final_Energy_Electricity_Share_Total_woBunkwoNonEn"]] , device="svg", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/Final_Energy_Electricity_Share_Total_woBunkwoNonEn.png"), g[["Final_Energy_Electricity_Share_Total_woBunkwoNonEn"]] , device="png", width = 12, height = 8, dpi=100, units = "in")

    quantile(filter(plotData, period == 2020)[["value"]], c(0, 0.25, 0.5, 0.75, 1))*100 # give out interquartiles 
    quantile(filter(plotData, period == 2040)[["value"]], c(0, 0.25, 0.5, 0.75, 1))*100 # give out interquartiles     
    quantile(filter(plotData, period == 2050)[["value"]], c(0, 0.25, 0.5, 0.75, 1))*100 # give out interquartiles 

```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["Final_Energy_Electricity_Share_Total_woBunkwoNonEn"]]
```

## Final Energy Electricity share total woBunker wo NonEnergy and sectors


```{r Final_Energy_Electricity_Share_woBunkNonEnd_sectors, echo=FALSE, include=FALSE}
  vars <- list(
    "Total"=c(
      "Final Energy|Electricity Share woBunkers woNonEnergy"
    ),
    "Industry"=c(
      "Final Energy|Industry|Electricity Share"
    ),
    "Buildings"=c(
      "Final Energy|Residential and Commercial|Electricity Share"
    ),
    "Transport"=c(
      "Final Energy|Transportation|Electricity Share"
    )
  )
  
  varTosector <- setNames(names(unlist(vars)),unlist(vars))
  
  plotData <- df %>%
    filter(variable %in% names(varTosector),
           period >=2005, period <= 2050,
           model %in% c("IMAGE","MESSAGE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(sector = factor(varTosector[as.character(variable)]))
                           #, labels=c("Total","Industry","Buildings","Transport")))

  g[["Final_Energy_Electricity_Share_woBunkNonEnd_sectors"]] <- ggplot(plotData,aes(x=period,y=value)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
    geom_line(size=1,aes(color=model,linetype=model)) +
    geom_point(aes(color=model)) +
    theme_minimal(base_size = 24) +
    facet_wrap(~sector) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2), limits = c(0,1)) +
    scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
    scale_linetype_manual(values = modelLinetype) +
    ylab("Final Energy Electricity shares (%)") +
    theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/svg/Final_Energy_Electricity_Share_woBunkNonEnd_sectors.svg"), g[["Final_Energy_Electricity_Share_woBunkNonEnd_sectors"]] , device="svg", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/Final_Energy_Electricity_Share_woBunkNonEnd_sectors.png"), g[["Final_Energy_Electricity_Share_woBunkNonEnd_sectors"]] , device="png", width = 12, height = 8, dpi=100, units = "in")

```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["Final_Energy_Electricity_Share_woBunkNonEnd_sectors"]]
```


## Final Energy Hydrogen shares - all sectors in 4 facets

```{r Final_Energy_Hydrogen_Share, echo=FALSE, include=FALSE}

  vars <- list(
    "Total"=c("Final Energy|Hydrogen Share"),
    "Industry"=c("Final Energy|Industry|Hydrogen Share"),
    "Buildings"=c("Final Energy|Residential and Commercial|Hydrogen Share"),
    "Transport"=c("Final Energy|Transportation|Hydrogen Share")
  )
  
  varTosector <- setNames(names(unlist(vars)),unlist(vars))
  
   plotData <- df %>%
    filter(variable %in% names(varTosector),
           period >=2005, period <= 2050,
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(sector = factor(varTosector[as.character(variable)]))

  g[["Final_Energy_Hydrogen_Share"]] <- ggplot(plotData,aes(x=period,y=value)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
    geom_line(size=1,aes(color=model,linetype=model)) +
    geom_point(aes(color=model)) +
    theme_minimal(base_size = 24) +
    facet_wrap(~sector) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2), limits = c(0,1)) +
    scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
    scale_linetype_manual(values = modelLinetype) +
    ylab("Final Energy Hydrogen shares (%)") +
    theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/svg/Final_Energy_Hydrogen_Share.svg"), g[["Final_Energy_Hydrogen_Share"]] , device="svg", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/Final_Energy_Hydrogen_Share.png"), g[["Final_Energy_Hydrogen_Share"]] , device="png", width = 12, height = 8, dpi=100, units = "in")

```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["Final_Energy_Hydrogen_Share"]]
```

## Final Energy Hydrogen shares - one plot per sector

```{r Final_Energy_H2_Share_Total, echo=FALSE, include=FALSE}
  
  plotData <- df %>%
    filter(variable == "Final Energy|Hydrogen Share",
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
           region == "EU27 & UK (*)")

   g[["Final_Energy_H2_Share_Total"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=scenario)) +
#      geom_line(data=histDataOrigN, size=3,linetype="solid", color = "black") +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2), limits = c(0,1)) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = c("historical"="solid","WP1 NPI"="solid", "WP1 NetZero"="solid")) +
      ggtitle("Share of Hydrogen in Final Energy") +
      ylab(expression(paste("(%)"))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/svg/Final_Energy_H2_Share_Total.svg"), g[["Final_Energy_H2_Share_Total"]] , device="svg", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/Final_Energy_H2_Share_Total.png"), g[["Final_Energy_H2_Share_Total"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  
    quantile(filter(plotData, period == 2020)[["value"]], c(0, 0.25, 0.5, 0.75, 1))*100 # give out interquartiles 
    quantile(filter(plotData, period == 2040)[["value"]], c(0, 0.25, 0.5, 0.75, 1))*100 # give out interquartiles     
    quantile(filter(plotData, period == 2050)[["value"]], c(0, 0.25, 0.5, 0.75, 1))*100 # give out interquartiles 

```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["Final_Energy_H2_Share_Total"]]
```

```{r Final_Energy_Hydrogen_Share_Transport, echo=FALSE, include=FALSE}
  
  plotData <- df %>%
    filter(variable == "Final Energy|Transportation|Hydrogen Share",
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
#           scenario %in% c("WP1 NPI", "WP1 NetZero", "WP1 NetZero-LimBio", "WP1 NetZero-LimCCS", "WP1 NetZero-LimNuc"),
           region == "EU27 & UK (*)")
#           region %in% c("EU27 & UK (*)","EUR"))

   g[["Final_Energy_Hydrogen_Share_Transport"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=scenario)) +
#      geom_line(data=histDataOrigN, size=3,linetype="solid", color = "black") +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2), limits = c(0,1)) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = c("historical"="solid","WP1 NPI"="solid", "WP1 NetZero"="solid", "WP1 NetZero-LimBio"="dotted", "WP1 NetZero-LimCCS"="dotdash", "WP1 NetZero-LimNuc"="longdash")) +
      ggtitle("Hydrogen share in Transportation Final Energy") +
      ylab(expression(paste("(%)"))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/svg/Final_Energy_Hydrogen_Share_Transport.svg"), g[["Final_Energy_Hydrogen_Share_Transport"]] , device="svg", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/Final_Energy_Hydrogen_Share_Transport.png"), g[["Final_Energy_Hydrogen_Share_Transport"]] , device="png", width = 12, height = 8, dpi=100, units = "in")

```


```{r, echo=FALSE, fig.width=12, fig.height=8}

  g[["Final_Energy_Hydrogen_Share_Transport"]]

```




## Final Energy Electricity share total woBunker wo NonEnergy

```{r Final_Energy_Hydrogen_Share_Total_woBunkwoNonEn, echo=FALSE, include=FALSE}
  
  plotData <- df %>%
    filter(variable == "Final Energy|Hydrogen Share woBunkers woNonEnergy",
           period >=2005, period <= 2050,
           model %in% c("IMAGE","MESSAGE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           scenario %in% c("WP1 NetZero"),
           region == "EU27 & UK (*)")

  plotDataHist <- histOrigN %>%
    filter(variable == "Final Energy|Hydrogen Share woBunkers woNonEnergy",
           period >=2005, period <= 2050,
           model == "Eurostat energy_sheets",
           scenario %in% c("historical"),
           region == "EUR")

   g[["Final_Energy_Hydrogen_Share_Total_woBunkwoNonEn"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=model)) +
 #     geom_line(data=plotDataHist, size=3,linetype="solid", color = "black") +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2), limits = c(0,1)) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = modelLinetype) +
#      scale_linetype_manual(values = c("historical"="solid","WP1 NPI"="solid", "WP1 NetZero"="solid")) +
      ggtitle("Share of Hydrogen in Final Energy Use (%)") +
      ylab(expression(paste("(%)"))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/svg/Final_Energy_Hydrogen_Share_Total_woBunkwoNonEn.svg"), g[["Final_Energy_Hydrogen_Share_Total_woBunkwoNonEn"]] , device="svg", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/Final_Energy_Hydrogen_Share_Total_woBunkwoNonEn.png"), g[["Final_Energy_Hydrogen_Share_Total_woBunkwoNonEn"]] , device="png", width = 12, height = 8, dpi=100, units = "in")

    quantile(filter(plotData, period == 2020)[["value"]], c(0, 0.25, 0.5, 0.75, 1))*100 # give out interquartiles 
    quantile(filter(plotData, period == 2040)[["value"]], c(0, 0.25, 0.5, 0.75, 1))*100 # give out interquartiles     
    quantile(filter(plotData, period == 2050)[["value"]], c(0, 0.25, 0.5, 0.75, 1))*100 # give out interquartiles 

```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["Final_Energy_Hydrogen_Share_Total_woBunkwoNonEn"]]
```
## SE bio-synfuel-fossil shares stacked bars

### Liquids
```{r, echo=FALSE, include=FALSE}

vars <- c(
  "BioLiq"="Secondary Energy|Liquids|Biomass",
  "Synliq" = "Secondary Energy|Liquids|Electricity",
  "FossLiq"="Secondary Energy|Liquids|Fossil")

carrier_color <- c(  
  "Synliq" = "#5ed5f0",
  "BioLiq" = "#005900",
  "FossLiq" = "#0c0c0c")

  plotData <- df %>%
    filter(variable %in% vars,
           period %in% c(2020,2030,2040,2050),
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(value = value * 1, # EJ
           model = factor(model, levels = c("LIMES", "Euro-Calliope","IMAGE","MEESA","MESSAGE","OSeMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH")),
           variable = factor(variable, levels = vars)) #order
  
  g[["SE_liq_Mix_Origin"]] <- ggplot(plotData,aes(x=model,y=value,fill=variable)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_bar(stat='identity', alpha = 0.8) +
#    coord_cartesian(ylim = c(0, 120)) +
    facet_wrap(~period,nrow=1) +
    theme_minimal(base_size = 24) +
    scale_fill_manual(values = setNames(carrier_color[names(vars)],vars), labels = setNames(names(vars), vars)) +
    ggtitle("Liquids by origin") +
    ylab("EJ/yr") +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5),
          axis.title.x=element_blank(),
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/SE_liq_Mix_Origin.png"), g[["SE_liq_Mix_Origin"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["SE_liq_Mix_Origin"]]
```

### Gases
```{r, echo=FALSE, include=FALSE}

vars <- c(
  "BioGas"="Secondary Energy|Gases|Biomass",
  "SynGas" = "Secondary Energy|Gases|Electricity",
  "FossGas"="Secondary Energy|Gases|Fossil")

carrier_color <- c(  
  "SynGas" = "#5ed5f0",
  "BioGas" = "#005900",
  "FossGas" = "#0c0c0c")

  plotData <- df %>%
    filter(variable %in% vars,
           period %in% c(2020,2030,2040,2050),
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(value = value * 1, # EJ
           model = factor(model, levels = c("LIMES", "Euro-Calliope","IMAGE","MEESA","MESSAGE","OSeMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH")),
           variable = factor(variable, levels = vars)) #order
  
  g[["SE_gases_Mix_Origin"]] <- ggplot(plotData,aes(x=model,y=value,fill=variable)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_bar(stat='identity', alpha = 0.8) +
#    coord_cartesian(ylim = c(0, 120)) +
    facet_wrap(~period,nrow=1) +
    theme_minimal(base_size = 24) +
    scale_fill_manual(values = setNames(carrier_color[names(vars)],vars), labels = setNames(names(vars), vars)) +
    ggtitle("Gases by origin") +
    ylab("EJ/yr") +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5),
          axis.title.x=element_blank(),
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/SE_gases_Mix_Origin.png"), g[["SE_gases_Mix_Origin"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["SE_gases_Mix_Origin"]]
```



### Solids
```{r, echo=FALSE, include=FALSE}

vars <- c(
  "BioSolids"="Secondary Energy|Solids|Biomass",
  "SynSolids" = "Secondary Energy|Solids|Electricity",
  "FossSolids"="Secondary Energy|Solids|Fossil")

carrier_color <- c(  
  "SynSolids" = "#5ed5f0",
  "BioSolids" = "#005900",
  "FossSolids" = "#0c0c0c")

  plotData <- df %>%
    filter(variable %in% vars,
           period %in% c(2020,2030,2040,2050),
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(value = value * 1, # EJ
           model = factor(model, levels = c("LIMES", "Euro-Calliope","IMAGE","MEESA","MESSAGE","OSeMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH")),
           variable = factor(variable, levels = vars)) #order
  
  g[["SE_Solids_Mix_Origin"]] <- ggplot(plotData,aes(x=model,y=value,fill=variable)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_bar(stat='identity', alpha = 0.8) +
#    coord_cartesian(ylim = c(0, 120)) +
    facet_wrap(~period,nrow=1) +
    theme_minimal(base_size = 24) +
    scale_fill_manual(values = setNames(carrier_color[names(vars)],vars), labels = setNames(names(vars), vars)) +
    ggtitle("Solids by origin") +
    ylab("EJ/yr") +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5),
          axis.title.x=element_blank(),
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/SE_Solids_Mix_Origin.png"), g[["SE_Solids_Mix_Origin"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["SE_Solids_Mix_Origin"]]
```

### Sol + Liq + Gas in SE
```{r, echo=FALSE, include=FALSE}

vars <- c(
  "BioGas"="Secondary Energy|Gases|Biomass",
  "SynGas" = "Secondary Energy|Gases|Electricity",
  "FossGas"="Secondary Energy|Gases|Fossil",
  "Imported SynLiq" = "SE-Import|Liquids|Synfuel",
  "Imported BioLiq" = "SE-Import|Liquids|Bio",
  "Imported FossLiq" = "SE-Import|Liquids|Fossil",
  "BioLiq"="Secondary Energy|Liquids|Biomass",
  "SynLiq" = "Secondary Energy|Liquids|Electricity",
  "FossLiq"="Secondary Energy|Liquids|Fossil",
  "BioSolids"="Secondary Energy|Solids|Biomass",
  "FossSolids"="Secondary Energy|Solids|Fossil"
  )

# vars <- c(          # other stacking order for nicer fossil/bio/syn-split
#   "SynGas" = "Secondary Energy|Gases|Electricity",
#   "SynLiq" = "Secondary Energy|Liquids|Electricity",
#   "Imported SynLiq" = "SE-Import|Liquids|Synfuel",
#   "Imported BioLiq" = "SE-Import|Liquids|Bio",
#       "BioGas"="Secondary Energy|Gases|Biomass",
#       "BioLiq"="Secondary Energy|Liquids|Biomass",
#       "BioSolids"="Secondary Energy|Solids|Biomass",
#   "FossGas"="Secondary Energy|Gases|Fossil",
#   "Imported FossLiq" = "SE-Import|Liquids|Fossil",
#   "FossLiq"="Secondary Energy|Liquids|Fossil",
#   "FossSolids"="Secondary Energy|Solids|Fossil"
#   )

carrier_color <- c(  
  "BioSolids" = "#005900",
  "FossSolids" = "#0c0c0c",
    "SynLiq" = "#0177d4",
  "Imported SynLiq" = "#0ed2f5",
    "Imported BioLiq" = "#697606",
  "BioLiq" = "#23ae1a",
  "FossLiq" = "#727272",
    "Imported FossLiq" = "#414902",
    "SynGas" = "#5ed5f0",
  "BioGas" = "#33ed27",
  "FossGas" = "#c8c8c8")

  plotData <- df %>%
    filter(variable %in% vars,
           period %in% c(2020,2030,2040,2050),
           scenario == "WP1 NetZero",
           model %in% c("IMAGE","MESSAGE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           region == "EU27 & UK (*)") %>%
    mutate(value = value * 1, # EJ
           model = factor(model, levels = c("IMAGE","MESSAGE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH")),
           variable = factor(variable, levels = vars)) #order
  
  g[["SE_GasLiqSol_Mix_Origin"]] <- ggplot(plotData,aes(x=model,y=value,fill=variable)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_bar(stat='identity', alpha = 0.8) +
#    coord_cartesian(ylim = c(0, 120)) +
    facet_wrap(~period,nrow=1) +
    theme_minimal(base_size = 24) +
    scale_fill_manual(values = setNames(carrier_color[names(vars)],vars), labels = setNames(names(vars), vars)) +
    ggtitle("Gas + Liq + Sol by origin") +
    ylab("EJ/yr") +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5),
          axis.title.x=element_blank(),
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/SE_GasLiqSol_Mix_Origin.png"), g[["SE_GasLiqSol_Mix_Origin"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["SE_GasLiqSol_Mix_Origin"]]
```

### Sol + Liq + Gas in FE
```{r, echo=FALSE, include=FALSE}

# vars <- c(
#     "BioGas"="Final Energy|Gases|Biomass",
#   "SynGas" = "Final Energy|Gases|Electricity",
#   "FossGas"="Final Energy|Gases|Fossil",
#   "BioLiq"="Final Energy|Liquids|Biomass",
#   "Synliq" = "Final Energy|Liquids|Electricity",
#   "FossLiq"="Final Energy|Liquids|Fossil",
#     "BioSolids"="Final Energy|Solids|Biomass",
#   "FossSolids"="Final Energy|Solids|Fossil"
#   )

vars <- c(               # other stacking order for nicer fossil/bio/syn-split
  "SynGases" = "Final Energy|Gases|Electricity",
  "SynLiquids" = "Final Energy|Liquids|Electricity",
  "BioGases"="Final Energy|Gases|Biomass",
  "BioLiquids"="Final Energy|Liquids|Biomass",
  "BioSolids"="Final Energy|Solids|Biomass",
  "FossGases"="Final Energy|Gases|Fossil",
  "FossLiquids"="Final Energy|Liquids|Fossil",
  "FossSolids"="Final Energy|Solids|Fossil"
  )

carrier_color <- c(  
  "BioSolids" = "#005900",
  "FossSolids" = "#0c0c0c",
  "SynLiquids" = "#0177d4",
  "BioLiquids" = "#23ae1a",
  "FossLiquids" = "#727272",
  "SynGases" = "#5ed5f0",
  "BioGases" = "#33ed27",
  "FossGases" = "#c8c8c8")

#,"MESSAGE"
  plotData <- df %>%
    filter(variable %in% vars,
           period %in% c(2020,2030,2040,2050),
           scenario == "WP1 NetZero",
           model %in% c("IMAGE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           region == "EU27 & UK (*)") %>%
    mutate(value = value * 1, # EJ
           model = factor(model, levels = c("IMAGE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH")),
           variable = factor(variable, levels = vars)) #order
  
  g[["FE_GasLiqSol_Mix_Origin"]] <- ggplot(plotData,aes(x=model,y=value,fill=variable)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_bar(stat='identity', alpha = 0.8) +
#    coord_cartesian(ylim = c(0, 120)) +
    facet_wrap(~period,nrow=1) +
    theme_minimal(base_size = 24) +
    scale_fill_manual(values = setNames(carrier_color[names(vars)],vars), labels = setNames(names(vars), vars)) +
    ggtitle("Gas + Liq + Sol by origin") +
    ylab("EJ/yr") +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5),
          axis.title.x=element_blank(),
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/FE_GasLiqSol_Mix_Origin.png"), g[["FE_GasLiqSol_Mix_Origin"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["FE_GasLiqSol_Mix_Origin"]]
```


## Secondary Energy bio-synfuel-fossil shares lineplot

```{r SE_bio-synfuel-fossil, echo=FALSE, include=FALSE}
  
  plotData <- df %>%
    filter(variable %in% c("SE|Liquids|Bio Share","SE|Liquids|Synfuel Share", "SE|Liquids|Fossil Share", "SE|Liquids|SumOfShares"),
           period >=2005, period <= 2050,
           model %in% c("IMAGE","MESSAGE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           scenario %in% c("WP1 NetZero"),
           region == "EU27 & UK (*)")

   g[["SE_liq_bio_synfuel_Share"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=variable)) +
 #     geom_line(data=plotDataHist, size=3,linetype="solid", color = "black") +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2), limits = c(0,1)) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = c("SE|Liquids|Synfuel Share"="solid","SE|Liquids|Bio Share"="dashed","SE|Liquids|Fossil Share"="dotted","SE|Liquids|SumOfShares"="solid")) +
      ggtitle("Share of bio and synfuel in SE Liq (%)") +
      ylab(expression(paste("(%)"))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/svg/SE_liq_bio_synfuel_Share.svg"), g[["SE_liq_bio_synfuel_Share"]] , device="svg", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/SE_liq_bio_synfuel_Share.png"), g[["SE_liq_bio_synfuel_Share"]] , device="png", width = 12, height = 8, dpi=100, units = "in")

    quantile(filter(plotData, period == 2020)[["value"]], c(0, 0.25, 0.5, 0.75, 1))*100 # give out interquartiles 
    quantile(filter(plotData, period == 2040)[["value"]], c(0, 0.25, 0.5, 0.75, 1))*100 # give out interquartiles     
    quantile(filter(plotData, period == 2050)[["value"]], c(0, 0.25, 0.5, 0.75, 1))*100 # give out interquartiles 

```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["SE_liq_bio_synfuel_Share"]]
```

## Secondary Energy bio-synfuel-fossil shares stacked bars

### Liquids
```{r, echo=FALSE, include=FALSE}

vars <- c(
  "BioLiq"="SE|Liquids|Bio Share",
  "Synliq" = "SE|Liquids|Synfuel Share",
  "FossLiw"="SE|Liquids|Fossil Share")

carrier_color <- c(  
  "Synliq" = "#5ed5f0",
  "BioLiq" = "#005900",
  "FossLiw" = "#0c0c0c")

  plotData <- df %>%
    filter(variable %in% vars,
           period %in% c(2020,2030,2040,2050),
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(value = value * 100, # Percent
           model = factor(model, levels = c("LIMES", "Euro-Calliope","IMAGE","MEESA","MESSAGE","OSeMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH")),
           variable = factor(variable, levels = vars)) #order
  
  g[["SE_liq_Orig"]] <- ggplot(plotData,aes(x=model,y=value,fill=variable)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_bar(stat='identity', alpha = 0.8) +
    coord_cartesian(ylim = c(0, 120)) +
    facet_wrap(~period,nrow=1) +
    theme_minimal(base_size = 24) +
    scale_fill_manual(values = setNames(carrier_color[names(vars)],vars), labels = setNames(names(vars), vars)) +
    ggtitle("Final Energy by sector") +
    ylab("Percent") +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5),
          axis.title.x=element_blank(),
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/SE_liq_Orig.png"), g[["SE_liq_Orig"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["SE_liq_Orig"]]
```

### Gases
```{r, echo=FALSE, include=FALSE}

vars <- c(
  "BioLiq"="SE|Gases|Bio Share",
  "Synliq" = "SE|Gases|Synfuel Share",
  "FossLiw"="SE|Gases|Fossil Share")

carrier_color <- c(  
  "Synliq" = "#5ed5f0",
  "BioLiq" = "#005900",
  "FossLiw" = "#0c0c0c")

  plotData <- df %>%
    filter(variable %in% vars,
           period %in% c(2020,2030,2040,2050),
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(value = value * 100, # Percent
           model = factor(model, levels = c("LIMES", "Euro-Calliope","IMAGE","MEESA","MESSAGE","OSeMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH")),
           variable = factor(variable, levels = vars)) #order
  
  g[["SE_liq_Orig"]] <- ggplot(plotData,aes(x=model,y=value,fill=variable)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_bar(stat='identity', alpha = 0.8) +
    coord_cartesian(ylim = c(0, 120)) +
    facet_wrap(~period,nrow=1) +
    theme_minimal(base_size = 24) +
    scale_fill_manual(values = setNames(carrier_color[names(vars)],vars), labels = setNames(names(vars), vars)) +
    ggtitle("Final Energy by sector") +
    ylab("Percent") +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5),
          axis.title.x=element_blank(),
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/SE_liq_Orig.png"), g[["SE_liq_Orig"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["SE_liq_Orig"]]
```

## SE H2 line

```{r SE_H2_line, echo=FALSE, include=FALSE}

  plotData <- df %>%
    filter(variable %in% c("Secondary Energy|Hydrogen","Secondary Energy|Electricity"),
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
           region == "EU27 & UK (*)") 

 g[["SE_H2_line"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) + 
#      coord_cartesian(ylim = c(0, 8000)) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=variable)) +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = c("Secondary Energy|Electricity"="solid","Secondary Energy|Hydrogen"="longdash")) +
      ggtitle("Hydrogen production") +
      ylab(expression(paste("[EJ/yr]"))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/SE_H2_line.png"), g[["SE_H2_line"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  quantile(filter(plotData, period == 2040)[["value"]], c(0.25, 0.5, 0.75)) # give out interquartiles
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["SE_H2_line"]]
```

## SE H2 line

```{r SEFE_H2_line, echo=FALSE, include=FALSE}

  plotData <- df %>%
    filter(variable %in% c("Final Energy|Hydrogen","Secondary Energy|Hydrogen"),
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
           region == "EU27 & UK (*)") 

 g[["SEFE_H2_line"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) + 
#      coord_cartesian(ylim = c(0, 8000)) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=variable)) +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = c("Final Energy|Hydrogen"="longdash","Secondary Energy|Hydrogen"="solid")) +
      ggtitle("Hydrogen production") +
      ylab(expression(paste("[EJ/yr]"))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/SEFE_H2_line.png"), g[["SEFE_H2_line"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  quantile(filter(plotData, period == 2040)[["value"]], c(0.25, 0.5, 0.75)) # give out interquartiles
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["SEFE_H2_line"]]
```

# Electricty {.tabset}

## NetZero

```{r, echo=FALSE, include=FALSE}

# fill missing OSEMBE Solar data
df <- calc_addVariable(df, "`Secondary Energy|Electricity|Solar`" = "`Secondary Energy|Electricity|Solar|PV` + `Secondary Energy|Electricity|Solar|CSP`", units = "EJ/yr", completeMissing = TRUE)
# df <- calc_addVariable(df, "`Secondary Energy|Electricity|SolarOldMinusNew`" = "`Secondary Energy|Electricity|Solar` - `Secondary Energy|Electricity|SolarNew`", units = "EJ/yr", completeMissing = TRUE)

vars <- c(
#  "Curtailment"="Secondary Energy|Electricity|Curtailment",
  "Ocean" = "Secondary Energy|Electricity|Ocean",
  "Biomass"="Secondary Energy|Electricity|Biomass",
  "Coal"="Secondary Energy|Electricity|Coal",
  "Gas"="Secondary Energy|Electricity|Gas",
  "Geothermal"="Secondary Energy|Electricity|Geothermal",
  "Hydro"="Secondary Energy|Electricity|Hydro",
  "Hydrogen"="Secondary Energy|Electricity|Hydrogen",
  "Nuclear"="Secondary Energy|Electricity|Nuclear",
  "Oil"="Secondary Energy|Electricity|Oil",
  "Solar"="Secondary Energy|Electricity|Solar",
  "Wind"="Secondary Energy|Electricity|Wind",
  #"Wind Offshore"="Secondary Energy|Electricity|Wind|Offshore",
  #"Wind Onshore"="Secondary Energy|Electricity|Wind|Onshore",
  "Trade"="Trade|Secondary Energy|Electricity|Volume"
)

carrier_color <- c(  
  "Ocean" = "#5ed5f0",
  "Biomass" = "#005900",
  "Coal" = "#0c0c0c",
  "Gas" = "#999959",
  "Geothermal" = "#e51900",
  "Hydro" = "#191999",
  "Hydrogen"    = "#5ed5b0",
  "Nuclear" = "#ff33ff",
  "Oil" = "#b30000",
  "Solar" = "#ffcc00",
  "Wind" = "#337fff",
  "Trade" = "#5c5c5c")

  plotData <- df %>%
    filter(variable %in% vars,
           period %in% c(2020,2030,2040,2050),
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(value = value*277.7777778, # EJ 2 TWh
           model = factor(model, levels = c("LIMES", "Euro-Calliope","IMAGE","MEESA","MESSAGE","OSeMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH")),
           variable = factor(variable, levels = vars)) #order
  
  g[["Electricty_NZero"]] <- ggplot(plotData,aes(x=model,y=value,fill=variable)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_bar(stat='identity', alpha = 0.8) +
    facet_wrap(~period,nrow=1) +
    theme_minimal(base_size = 24) +
    scale_fill_manual(values = setNames(carrier_color[names(vars)],vars), labels = setNames(names(vars), vars)) +
    ggtitle("Electricity Generation") +
    ylab("TWh") +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5),
          axis.title.x=element_blank(),
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/svg/Electricty_NZero.svg"), g[["Electricty_NZero"]] , device="svg", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/Electricty_NZero.png"), g[["Electricty_NZero"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  

```


```{r, echo=FALSE, fig.width=12, fig.height=8}

  g[["Electricty_NZero"]]

```

## VRE share in Electricity
```{r add_variables_VRE, echo=FALSE, include=FALSE}


  df <- calc_addVariable(df, "`Secondary Energy|Electricity|WindSolar`" = "`Secondary Energy|Electricity|Wind` + `Secondary Energy|Electricity|Solar`", units = "EJ/yr")
  df <- calc_addVariable(df, "`Secondary Energy|Electricity|Sum`" = "`Secondary Energy|Electricity|Ocean` + `Secondary Energy|Electricity|Biomass` + `Secondary Energy|Electricity|Coal` + `Secondary Energy|Electricity|Gas` + `Secondary Energy|Electricity|Geothermal` + `Secondary Energy|Electricity|Hydro` + `Secondary Energy|Electricity|Hydrogen` + `Secondary Energy|Electricity|Nuclear` + `Secondary Energy|Electricity|Oil` + `Secondary Energy|Electricity|WindSolar` ", units = "EJ/yr")
  df <- calc_addVariable(df, "`Secondary Energy|Electricity|DiffToSum`" = "`Secondary Energy|Electricity` - `Secondary Energy|Electricity|Sum`", units = "EJ/yr")
  df <- calc_addVariable(df, "`Secondary Energy|Electricity|VRE Share`" = "`Secondary Energy|Electricity|WindSolar` / `Secondary Energy|Electricity`", units = "%")

  
  # histOrigN <- calc_addVariable(histOrigN, "`SE|Electricity|Sum`" = "`SE|Electricity|Coal` + `SE|Electricity|Biomass` + `SE|Electricity|Gas` + `SE|Electricity|Hydro` + `SE|Electricity|Nuclear` + `SE|Electricity|Wind` + `SE|Electricity|Solar` ", units = "EJ/yr")
  # histOrigN <- calc_addVariable(histOrigN, "`SE|Electricity|DiffToSum`" = "`SE|Electricity` - `SE|Electricity|Sum`", units = "EJ/yr")
  histOrigN <- calc_addVariable(histOrigN, "`SE|Electricity|WindSolar`" = "`SE|Electricity|Wind` + `SE|Electricity|Solar`", units = "EJ/yr")
  histOrigN <- calc_addVariable(histOrigN, "`SE|Electricity|VRE Share`" = "`SE|Electricity|WindSolar` / `SE|Electricity`", units = "%")
```

```{r SE_Electricity_VRE_Share, echo=FALSE, include=FALSE}

  
  plotData <- df %>%
    filter(variable == "Secondary Energy|Electricity|VRE Share",
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
#           scenario %in% c("WP1 NPI", "WP1 NetZero", "WP1 NetZero-LimBio", "WP1 NetZero-LimCCS", "WP1 NetZero-LimNuc"),
           region == "EU27 & UK (*)")
#           region %in% c("EU27 & UK (*)","EUR"))
  
    histDataOrigN <- histOrigN %>%
    filter(variable == "SE|Electricity|VRE Share",
           region == "EUR",
           model == "Ember")

   g[["SE_Electricity_VRE_Share"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=model)) +
      geom_line(data=histDataOrigN, size=3,linetype="solid", color = "black") +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, 1, by = 0.2), limits = c(0,1)) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = modelLinetype) +
#      scale_linetype_manual(values = c("historical"="solid","WP1 NPI"="solid", "WP1 NetZero"="solid", "WP1 NetZero-LimBio"="dotted", "WP1 NetZero-LimCCS"="dotdash", "WP1 NetZero-LimNuc"="longdash")) +
      ggtitle("Share in electricity generation (%)") +
      ylab(expression(paste("(%)"))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/svg/SE_Electricity_VRE_Share.svg"), g[["SE_Electricity_VRE_Share"]] , device="svg", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/SE_Electricity_VRE_Share.png"), g[["SE_Electricity_VRE_Share"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  
      quantile(filter(df, scenario %in% c("WP1 NetZero"), variable == "Secondary Energy|Electricity|VRE Share", region == "EU27 & UK (*)", period == 2050)[["value"]], c(0, 0.25, 0.5, 0.75, 1))*100 # give out interquartiles 

```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["SE_Electricity_VRE_Share"]]
```

## VRE electricity generation

```{r SE_Electricity_VRE, echo=FALSE, include=FALSE}

  plotData <- df %>%
    filter(variable == "Secondary Energy|Electricity|WindSolar",
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
#           scenario %in% c("WP1 NPI", "WP1 NetZero", "WP1 NetZero-LimBio", "WP1 NetZero-LimCCS", "WP1 NetZero-LimNuc"),
           region == "EU27 & UK (*)") %>%
     mutate(value = value*277.7777778) # EJ 2 TWh
#           region %in% c("EU27 & UK (*)","EUR"))
  
    histDataOrigN <- histOrigN %>%
    filter(variable == "SE|Electricity|WindSolar",
           region == "EUR",
           model == "Ember") %>%
     mutate(value = value*277.7777778) # EJ 2 TWh

 g[["SE_Electricity_VRE"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) + 
      coord_cartesian(ylim = c(0, 7000)) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=model)) +
      geom_line(data=histDataOrigN, size=3,linetype="solid", color = "black") +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = modelLinetype) +
#      scale_linetype_manual(values = c("historical"="solid","WP1 NPI"="solid", "WP1 NetZero"="solid", "WP1 NetZero-LimBio"="dotted", "WP1 NetZero-LimCCS"="dotdash", "WP1 NetZero-LimNuc"="longdash")) +
      ggtitle("Electricity Generation from Wind and Solar") +
      ylab(expression(paste("[TWh/yr]"))) +
      theme(panel.background = element_rect(fill="#FFFFFF", color = NA),
            plot.background = element_rect(fill="#FFFFFF", color = NA))


  ggsave(paste0("./output/", time, "/svg/SE_Electricity_VRE.svg"), g[["SE_Electricity_VRE"]] , device="svg", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/SE_Electricity_VRE.png"), g[["SE_Electricity_VRE"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  
  quantile(filter(plotData, period == 2040)[["value"]], c(0.25, 0.5, 0.75)) # give out interquartiles

```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["SE_Electricity_VRE"]]
```

## Calculate expansion of electricity generation from biomass/Hydro

```{r SE_Electricity_bio_hydro, echo=FALSE, include=FALSE}

  auxData <- df %>%
    filter(variable %in% c("Secondary Energy|Electricity|Hydro","Secondary Energy|Electricity|Biomass"),
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
           region == "EU27 & UK (*)")

  auxData <- left_join(
      df  %>%
    filter(variable %in% c("Secondary Energy|Electricity|Hydro","Secondary Energy|Electricity|Biomass"),
           period %in% c(2020,2030,2040,2050),
           scenario %in% c("WP1 NetZero"),
           region == "EU27 & UK (*)")  %>%
      mutate(numerator=value)
    ,
      df  %>%
    filter(variable %in% c("Secondary Energy|Electricity|Hydro","Secondary Energy|Electricity|Biomass"),
           period == 2020,
           scenario %in% c("WP1 NetZero"),
           region == "EU27 & UK (*)")  %>%
        mutate(denominator=value) %>%
        select(model,variable,denominator)
      , by = join_by(model == model,variable == variable)
      ) %>%
    mutate(percentage = numerator/denominator,
           reduction = 1-percentage) %>%
    na.omit()
  
    quantile(filter(auxData, variable == "Secondary Energy|Electricity|Hydro", period == 2040)[["percentage"]], c(0, 0.25, 0.5, 0.75, 1))*100 # give out interquartiles
    quantile(filter(auxData, variable == "Secondary Energy|Electricity|Biomass", period == 2040)[["percentage"]], c(0, 0.25, 0.5, 0.75, 1))*100 # give out interquartiles



```

# PE
## PE Gas


# Compare SE/FE

```{r compare_SE-FE_LiqSolGas, echo=FALSE, include=FALSE}
seVars <- c(
  "BioGas"="Secondary Energy|Gases|Biomass",
  "SynGas" = "Secondary Energy|Gases|Electricity",
  "FossGas"="Secondary Energy|Gases|Fossil",
  "Imported SynLiq" = "SE-Import|Liquids|Synfuel",
  "Imported BioLiq" = "SE-Import|Liquids|Bio",
  "Imported FossLiq" = "SE-Import|Liquids|Fossil",
  "BioLiq"="Secondary Energy|Liquids|Biomass",
  "SynLiq" = "Secondary Energy|Liquids|Electricity",
  "FossLiq"="Secondary Energy|Liquids|Fossil",
  "BioSolids"="Secondary Energy|Solids|Biomass",
  "FossSolids"="Secondary Energy|Solids|Fossil"
  )

feVars <- c(
  "BioGas"="Final Energy|Gases|Biomass",
  "SynGas" = "Final Energy|Gases|Electricity",
  "FossGas"="Final Energy|Gases|Fossil",
  "BioLiq"="Final Energy|Liquids|Biomass",
  "SynLiq" = "Final Energy|Liquids|Electricity",
  "FossLiq"="Final Energy|Liquids|Fossil",
  "BioSolids"="Final Energy|Solids|Biomass",
  "FossSolids"="Final Energy|Solids|Fossil"
  )

carrierType <- list(
   "Gas"=c("BioGas","SynGas","FossGas"),
   "Liq"=c("BioLiq","SynLiq","FossLiq"),
   "Imported Liq" = c("Imported SynLiq","Imported BioLiq","Imported FossLiq"),
   "Solids"=c("BioSolids","FossSolids")
   )

vars = c(seVars,feVars)
invSe = setNames(names(seVars),seVars)
invFe = setNames(names(feVars),feVars)

plotData <- df %>%
    filter(variable %in% vars,
           period %in% c(2020,2050),
           scenario == "WP1 NetZero",
           model %in% c("IMAGE","MESSAGE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           region == "EU27 & UK (*)") %>%
  mutate(carrierLevel = ifelse(variable %in% seVars, "se", "fe"),
         label = ifelse(variable %in% seVars, invSe[as.character(variable)], invFe[as.character(variable)]),
         totalLabel = ifelse(label %in% carrierType[["Gas"]], "Gas", 
                             ifelse(label %in% carrierType[["Liq"]], "Liq", 
                                    ifelse(label %in% carrierType[["Imported Liq"]], "Imported Liq",
                                           "Solids"))),
          type = "detail" 
  ) %>%
  mutate( #order
    carrierLevel = factor(carrierLevel, levels = c("se", "fe")),
    label = factor(label, levels = unique(names(vars))),
    totalLabel = factor(totalLabel, levels = names(carrierType))
  )

plotDataTotals <- plotData %>%
  group_by(model, scenario, region, period, carrierLevel, totalLabel) %>%
  summarise(total = sum(value), .groups="keep") %>%
  mutate(type = "total")

carrier_color <- c(  
  "Gas" = "#62623c",
  "SynGas" = "#cbcb95",
  "BioGas" = "#e6f1f4",
  "FossGas" = "#adad5a",
  "Liq" = "#0000cc",
  "Imported Liq" = "#b4b4db",
  "Synliq" = "#79a6d2",
  "BioLiq" = "#5ed5f0",
  "FossLiq" = "#0177d4",
  "Solids" = "#005900",
  "BioSolids" = "#68b468",
  "FossSolids" = "#408240"
  )

g[["FE_GasLiqSol_Mix_SE_FE_mod1"]] <- ggplot(plotData,aes(x=type, y=value)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_bar(aes(fill = label), stat='identity', alpha = 0.8) +
    geom_bar(data = plotDataTotals, aes(x=type, y=total, fill = totalLabel), stat='identity', alpha = 0.8) +
    facet_grid(model~period+carrierLevel) +
    theme_minimal(base_size = 24) +
    scale_fill_manual(values = carrier_color, breaks = names(carrier_color)) +
    ggtitle("Gas + Liq + Sol in SE and FE") +
    ylab("EJ/yr") +
    theme(axis.text.x = element_blank(),
          axis.title.x=element_blank(),
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA),
          legend.title=element_blank())

  ggsave(paste0("./output/", time, "/png/FE_GasLiqSol_Mix_SE_FE_mod1.png"), g[["FE_GasLiqSol_Mix_SE_FE_mod1"]] , device="png", width = 12, height = 8, dpi=100, units = "in")

```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["FE_GasLiqSol_Mix_SE_FE_mod1"]]
```

# Compare SE/FE - try2

```{r compare_SE-FE_LiqSolGas_new, echo=FALSE, include=FALSE}

seVars <- c(
  "BioGas"="Secondary Energy|Gases|Biomass",
  "SynGas" = "Secondary Energy|Gases|Electricity",
  "FossGas"="Secondary Energy|Gases|Fossil",
  "Imported SynLiq" = "SE-Import|Liquids|Synfuel",
  "Imported BioLiq" = "SE-Import|Liquids|Bio",
  "Imported FossLiq" = "SE-Import|Liquids|Fossil",
  "BioLiq"="Secondary Energy|Liquids|Biomass",
  "SynLiq" = "Secondary Energy|Liquids|Electricity",
  "FossLiq"="Secondary Energy|Liquids|Fossil",
  "BioSolids"="Secondary Energy|Solids|Biomass",
  "FossSolids"="Secondary Energy|Solids|Fossil"
  )

feVars <- c(
  "BioGas"="Final Energy|Gases|Biomass",
  "SynGas" = "Final Energy|Gases|Electricity",
  "FossGas"="Final Energy|Gases|Fossil",
  "BioLiq"="Final Energy|Liquids|Biomass",
  "SynLiq" = "Final Energy|Liquids|Electricity",
  "FossLiq"="Final Energy|Liquids|Fossil",
  "BioSolids"="Final Energy|Solids|Biomass",
  "FossSolids"="Final Energy|Solids|Fossil"
  )

carrierType <- list(
   "Gas"=c("BioGas","SynGas","FossGas"),
   "Imported Liq" = c("Imported SynLiq","Imported BioLiq","Imported FossLiq"),
   "Liq"=c("BioLiq","SynLiq","FossLiq"),
   "Solids"=c("BioSolids","FossSolids")
   )

vars <- c(seVars,feVars)
invSe <- setNames(names(seVars),seVars)
invFe <- setNames(names(feVars),feVars)

plotData <- df %>%
    filter(variable %in% vars,
           period %in% c(2020,2050),
           scenario == "WP1 NetZero",
           model %in% c("IMAGE","MESSAGE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           region == "EU27 & UK (*)") %>%
  mutate(carrierLevel = ifelse(variable %in% seVars, "se", "fe"),
         label = ifelse(variable %in% seVars, invSe[as.character(variable)], invFe[as.character(variable)]),
         totalLabel = ifelse(label %in% carrierType[["Gas"]], "Gas", 
                             ifelse(label %in% carrierType[["Liq"]], "Liq", 
                                    ifelse(label %in% carrierType[["Imported Liq"]], "Imported Liq",
                                           "Solids"))),
          type = "detail"
  ) %>%
  mutate( #order
    carrierLevel = factor(carrierLevel, levels = c("se", "fe")),
    label = factor(label, levels = unique(names(vars))),
    totalLabel = factor(totalLabel, levels = names(carrierType))
  )

plotDataTotalsCalc <- plotData %>%
  group_by(model, scenario, region, period, carrierLevel, totalLabel) %>%
  summarise(total = sum(value), .groups="keep") %>%
  mutate(type = "calc")

seTotals <- c(
  "Gas"="Secondary Energy|Gases",
  "Liq"="Secondary Energy|Liquids",
  "Solids"="Secondary Energy|Solids"
  )

feTotals <- c(
  "Gas"="Final Energy|Gases",
  "Liq"="Final Energy|Liquids",
  "Solids"="Final Energy|Solids"
  )

varsTotals <- c(seTotals,feTotals)
invSeTotals <- setNames(names(seTotals),seTotals)
invFeTotals <- setNames(names(feTotals),feTotals)

plotDataTotals <-  df %>%
    filter(variable %in% varsTotals,
           period %in% c(2020,2050),
           scenario == "WP1 NetZero",
           model %in% c("IMAGE","MESSAGE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           region == "EU27 & UK (*)") %>%
  mutate(carrierLevel = ifelse(variable %in% seTotals, "se", "fe"),
         label = ifelse(variable %in% seTotals, invSeTotals[as.character(variable)], invFeTotals[as.character(variable)]),
         type = "total"
  ) %>%
  mutate( #order
    carrierLevel = factor(carrierLevel, levels = c("se", "fe")),
    label = factor(label, levels = unique(names(varsTotals)))
  )

# carrier_color <- c(  
#   "BioSolids" = "#005900",
#   "FossSolids" = "#0c0c0c",
#     "SynLiq" = "#0177d4",
#   "Imported SynLiq" = "#0ed2f5",
#     "Imported BioLiq" = "#697606",
#   "BioLiq" = "#23ae1a",
#   "FossLiq" = "#727272",
#     "Imported FossLiq" = "#414902",
#     "SynGas" = "#5ed5f0",
#   "BioGas" = "#33ed27",
#   "FossGas" = "#c8c8c8")

carrier_color <- c(  
  "Gas" = "#62623c",
  "SynGas" = "#5ed5f0",
  "BioGas" = "#33ed27",
  "FossGas" = "#c8c8c8",
  "Liq" = "#0000cc",
  "Imported SynLiq" = "#f7f70b",
    "Imported BioLiq" = "#b66713",
      "Imported FossLiq" = "#b30000",
  "Imported Liq" = "#b30000",
  "Synliq" = "#79a6d2",
  "BioLiq" = "#23ae1a",
  "FossLiq" = "#727272",
  "Solids" = "#005900",
  "BioSolids" = "#005900",
  "FossSolids" = "#0c0c0c"
  )

# carrier_color <- c(  
#   "Gas" = "#62623c",
#   "SynGas" = "#cbcb95",
#   "BioGas" = "#e6f1f4",
#   "FossGas" = "#adad5a",
#   "Liq" = "#0000cc",
#   "Imported Liq" = "#b4b4db",
#   "Synliq" = "#79a6d2",
#   "BioLiq" = "#5ed5f0",
#   "FossLiq" = "#0177d4",
#   "Solids" = "#005900",
#   "BioSolids" = "#68b468",
#   "FossSolids" = "#Black"
#   )

modelName <- c("IMAGE","MESSAGE")
modelName <- c("TIAM-ECN","WITCH")

plotDatafewModels <- plotData %>%
    filter(model %in% modelName )

plotDataTotalsCalcfewModels <- plotDataTotalsCalc %>%
    filter(model %in% modelName )

plotDataTotalsfewModels <-   plotDataTotals %>%
    filter(model %in% modelName )

g[["FE_GasLiqSol_Mix_SE_FE_new"]] <- ggplot(plotDatafewModels,aes(x=type, y=value)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_bar(aes(fill = label), stat='identity', alpha = 0.8) +
    geom_bar(data = plotDataTotalsCalcfewModels, aes(x=type, y=total, fill = totalLabel), stat='identity', alpha = 0.8) +
    geom_bar(data = plotDataTotalsfewModels, aes(x=type, y=value, fill = label), stat='identity', alpha = 0.8) +
    facet_grid(model~period+carrierLevel) +
    theme_minimal(base_size = 24) +
    scale_fill_manual(values = carrier_color, breaks = names(carrier_color)) +
    scale_x_discrete(limits=c("detail","calc","total")) +
    ggtitle("Gas + Liq + Sol in SE and FE") +
    ylab("EJ/yr") +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5), #axis.text.x = element_blank(),
          axis.title.x=element_blank(),
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA),
          legend.title=element_blank())


  ggsave(paste0("./output/", time, "/png/FE_GasLiqSol_Mix_SE_FE_new_ImMes.png"), g[["FE_GasLiqSol_Mix_SE_FE_new"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  ggsave(paste0("./output/", time, "/png/FE_GasLiqSol_Mix_SE_FE_new_WITCHTIAM.png"), g[["FE_GasLiqSol_Mix_SE_FE_new"]] , device="png", width = 12, height = 8, dpi=100, units = "in")

```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["FE_GasLiqSol_Mix_SE_FE_new"]]
```

# Trade

## Trade flows Stacked Bars

```{r, echo=FALSE, include=FALSE}

vars <- c(
  "SE Elec" = "Trade|Secondary Energy|Electricity|Volume",
  "SE H2" = "Trade|Secondary Energy|Hydrogen|Volume",
  "SE Liq|Bio" = "Trade|Secondary Energy|Liquids|Biomass|Volume",
  "SE Liq|Coal" = "Trade|Secondary Energy|Liquids|Coal|Volume",
  "SE Liq|Oil" = "Trade|Secondary Energy|Liquids|Oil|Volume",
  "SE Liq|Elec" = "Trade|Secondary Energy|Liquids|Electricity|Volume",
  "SE Liq|H2" = "Trade|Secondary Energy|Liquids|Hydrogen|Volume",
  "PE Bio"="Trade|Primary Energy|Biomass|Volume",
  "PE Coal" = "Trade|Primary Energy|Coal|Volume",
  "PE Gas"="Trade|Primary Energy|Gas|Volume",
  "PE Oil"="Trade|Primary Energy|Oil|Volume")


carrier_color <- c(  
  "PE Bio"      = "#005900",
  "PE Coal"     = "#0c0c0c",
  "PE Gas"      = "#b3b34b",
  "PE Oil"      = "#e51900",
  "SE Elec"     = "#fff300",
  "SE H2"       = "#00ffe4",
  "SE Liq|Bio"  = "#80a569",
  "SE Liq|Coal" = "#828a7d",
  "SE Liq|Oil"  = "#bd945b",
  "SE Liq|Elec" = "#e7e760",
  "SE Liq|H2"   = "#95dfdd")

  plotData <- df %>%
    filter(variable %in% vars,
           period %in% c(2020,2030,2040,2050),
           scenario == "WP1 NetZero",
           region == "EU27 & UK (*)") %>%
    mutate(value = value * - 1, # EJ 2 TWh
           model = factor(model, levels = c("LIMES", "IMAGE","MESSAGE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH")),
           variable = factor(variable, levels = vars)) #order
  
  g[["Trade"]] <- ggplot(plotData,aes(x=model,y=value,fill=variable)) +
    geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
    geom_bar(stat='identity', alpha = 0.8) +
    facet_wrap(~period,nrow=1) +
    theme_minimal(base_size = 24) +
    scale_fill_manual(values = setNames(carrier_color[names(vars)],vars), labels = setNames(names(vars), vars)) +
    ggtitle("Imports") +
    ylab("TWh") +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = 0.5),
          axis.title.x=element_blank(),
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/Trade.png"), g[["Trade"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["Trade"]]
```


```{r, echo=FALSE}

### LULUCF

# It is necessary to check also if hist data covers all years 
hist_lulucf <- histOrigN %>% 
  filter(variable == "Emi|CO2|Land-Use Change",
         period >= 2018, period <= 2022,
         region == "EUR",
         model == "UNFCCC") %>%
  summarize(Mean = mean(value, na.rm=TRUE)) %>%
  pull(Mean)

# Type 1: Model has AFOLU CO2 data reported (equivalent to LULUCF). 
df_type1_orig <- df %>% # reported afolu data models
  filter(variable == "Emissions|CO2|AFOLU",
         period %in% c(2020,2030,2040,2050),
         scenario == "WP1 NetZero",
         region == "EU27 & UK (*)") %>%
  group_by(model) %>%
  filter(sum(value*value) != 0) %>%
  ungroup()

model_w_lulucf <- df_type1_orig %>%
  pull(model) %>%
  unique()

df_lulucf_adj <- left_join( # calculating adjustment factors based on 2020 historical values
  df_type1_orig,
  df_type1_orig %>%
    filter(period == 2020) %>%
    mutate(hist2020 = hist_lulucf,
           multFactor = hist_lulucf / value,
           diffFactor = hist_lulucf - value) %>%
    select(-period, -value),
  by = join_by(model == model, scenario == scenario, region == region, variable == variable, unit == unit)
  ) %>%
  mutate(
    valueAdjMult = value * multFactor,
    valueAdjDiff = value + diffFactor
  )

df_lulucf_w_data <- df_lulucf_adj %>% # calculating the adjusted data using the difference between historical values to translate the model values instead of using a multiplicative factor
  mutate(value = valueAdjDiff) %>%
  select(model, scenario, region, variable, unit, period, value)

# Type 2: Model has no CO2 AFOLU data reported
model_wo_lulucf <- df %>% filter(!(model %in% model_w_lulucf)) %>% pull(model) %>% unique() 

df_lulucf_wo_data <- full_join( #assigning synthetic value to Emissions|CO2|AFOLU
  df_lulucf_w_data %>% ungroup() %>% select(-model, -value) %>% unique(),
  data.frame(model=rep(model_wo_lulucf,each=4), period=rep(c(2020,2030,2040,2050),length(model_wo_lulucf)), value = rep(c(hist_lulucf, -310, -310, -310),length(model_wo_lulucf))),
  by = join_by(period == period)
  )

# Synthetic CO2 AFOLU data
df_lulucf <- rbind(
  df_lulucf_w_data,
  df_lulucf_wo_data
  ) %>%
  mutate(variable = "Emissions|CO2|AFOLU synthetic")


### non GHG

hist_nonCO2 <- histOrigN %>% 
  filter(period >= 2018, period <= 2022,
         region == "EUR",
         model == "UNFCCC") %>%
  calc_addVariable("`Emi|Kyoto Gases|non-CO2 calc`" = "`Emi|GHG` - `Emi|CO2`", units = "MtCO2e/yr", only.new = TRUE) %>% 
  summarize(Mean = mean(value, na.rm=TRUE)) %>%
  pull(Mean)

# Type A: Models that include non-CO2 emissions
model_w_nonCO2 <- df %>% # reported afolu data models
  filter(variable == "Emissions|Kyoto Gases",
         period %in% c(2020,2030,2040,2050),
         scenario == "WP1 NetZero",
         region == "EU27 & UK (*)") %>%
  group_by(model) %>%
  filter(sum(value*value) != 0) %>%
  ungroup() %>%
  pull(model) %>%
  unique()

df_nonCO2_w_data <- calc_addVariable(df, "`Emi|Kyoto Gases|non-CO2 calc`" = "`Emissions|Kyoto Gases` - `Emissions|CO2`", units = "MtCO2e/yr", only.new = TRUE) %>%
  filter(period %in% c(2020,2030,2040,2050),
         scenario == "WP1 NetZero",
         region == "EU27 & UK (*)",
         model %in% model_w_nonCO2) 

# Type B: Model has no GHG data reported
model_wo_nonCO2 <- df %>% filter(!(model %in% model_w_nonCO2)) %>% pull(model) %>% unique() 

df_nonCO2_wo_data <- full_join( #assigning synthetic value to Emissions|CO2|AFOLU
  df_nonCO2_w_data %>% ungroup() %>% select(-model, -value) %>% unique(),
  data.frame(model=rep(model_wo_nonCO2,each=4), period=rep(c(2020,2030,2040,2050),length(model_wo_nonCO2)), value = rep(c(hist_nonCO2, 580, 520, 510),length(model_wo_nonCO2))),
  by = join_by(period == period)
  )

# Synthetic CO2 AFOLU data
df_nonCO2 <- rbind(
  df_nonCO2_w_data,
  df_nonCO2_wo_data
  ) %>%
  mutate(variable = "Emissions|Kyoto Gases|non-CO2 synthetic")

# adding synthetic data to main data
df <- rbind(
  df %>% filter(!(variable %in% c("Emissions|CO2|AFOLU synthetic","Emissions|Kyoto Gases|non-CO2 synthetic"))),
  df_lulucf,
  df_nonCO2
  )

```

# Synthetic data {.tabset}
## Synthetic LULUCF line plot
```{r lulucf_line, echo=FALSE, include=FALSE}

  plotData <- df %>%
    filter(variable == "Emissions|CO2|AFOLU synthetic",
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
           model %in% c("IMAGE","MEESA","OSEMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           region == "EU27 & UK (*)")


  histDataOrigN <- histOrigN %>%
    filter(variable == "Emi|CO2|Land-Use Change",
           region == "EUR",
           model == "UNFCCC")
  
  g[["lulucf_line"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=model)) +
      geom_line(data=histDataOrigN, size=1,linetype="solid", color = "black") +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = modelLinetype) +
#     scale_linetype_manual(values = c("historical"="solid","WP1 NPI"="solid", "WP1 NetZero"="solid")) +
      ggtitle("LULUCF (synthetic)") +
      ylab("Mt CO2/yr") +
      theme(axis.title.x=element_blank(),
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/lulucf_line.png"), g[["lulucf_line"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["lulucf_line"]]
```

## Synthetic non-CO2 emissions line plot
```{r nonCO2_line, echo=FALSE, include=FALSE}

  plotData <- df %>%
    filter(variable == "Emissions|Kyoto Gases|non-CO2 synthetic",
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
           model %in% c("IMAGE","MEESA","OSEMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           region == "EU27 & UK (*)")

  histDataOrigN <- histOrigN %>%
    filter(region == "EUR",
           model == "UNFCCC") %>%
    calc_addVariable("`Emi|Kyoto Gases|non-CO2 calc`" = "`Emi|GHG` - `Emi|CO2`", units = "MtCO2e/yr", only.new = TRUE)
  
  g[["nonCO2_line"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=model)) +
      geom_line(data=histDataOrigN, size=1,linetype="solid", color = "black") +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = modelLinetype) +
#     scale_linetype_manual(values = c("historical"="solid","WP1 NPI"="solid", "WP1 NetZero"="solid")) +
      ggtitle("non-CO2 emissions (synthetic)") +
      ylab("Mt CO2e/yr") +
      theme(axis.title.x=element_blank(),
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/nonCO2_line.png"), g[["nonCO2_line"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["nonCO2_line"]]
```



```{r, echo=FALSE, include=FALSE}

  df <- rbind(
    df %>% filter(variable != "Emissions|Kyoto Gases synthetic"),
    df %>%
      filter(variable %in% c("Emissions|CO2|Energy and Industrial Processes" , "Emissions|CO2|Other" , "Emissions|CO2|Waste" , "Emissions|CO2|Other Removal" , "Emissions|CO2|AFOLU synthetic" , "Emissions|Kyoto Gases|non-CO2 synthetic")) %>%
      group_by(model, scenario, region, period) %>%
      summarize(value = sum(value)) %>%
      mutate(variable = "Emissions|Kyoto Gases synthetic",
             unit = "MtCO2e/yr") %>%
      relocate(any_of(colnames(df)))
    )
  
```

## Synthetic GHG emissions line plot
```{r syntheticGHG_line, echo=FALSE, include=FALSE}

  plotData <- df %>%
    filter(variable == "Emissions|Kyoto Gases synthetic",
           period >=2005, period <= 2050,
           scenario %in% c("WP1 NetZero"),
           model %in% c("IMAGE","MEESA","OSEMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"),
           region == "EU27 & UK (*)")

  histDataOrigN <- histOrigN %>%
    filter(region == "EUR",
           model == "UNFCCC",
           variable == "Emi|GHG")
  
  g[["GHG_synthetic_line"]] <- ggplot(plotData,aes(x=period,y=value)) +
      geom_hline(yintercept=0, color = "black", linewidth=1, alpha = 0.5) +
      geom_vline(xintercept=2020, color = "black", linewidth=1, alpha = 0.5,linetype="dashed") +
      geom_line(size=1,aes(color=model,linetype=model)) +
      geom_line(data=histDataOrigN, size=1,linetype="solid", color = "black") +
      geom_point(aes(color=model)) +
      theme_minimal(base_size = 24) +
      scale_color_manual(values = setNames(color[levels(plotData$model)],levels(plotData$model))) +
      scale_linetype_manual(values = modelLinetype) +
#     scale_linetype_manual(values = c("historical"="solid","WP1 NPI"="solid", "WP1 NetZero"="solid")) +
      ggtitle("GHG emissions (synthetic)") +
      ylab("Mt CO2e/yr") +
      theme(axis.title.x=element_blank(),
          panel.background = element_rect(fill="#FFFFFF", color = NA),
          plot.background = element_rect(fill="#FFFFFF", color = NA))

  ggsave(paste0("./output/", time, "/png/GHG_synthetic_line.png"), g[["GHG_synthetic_line"]] , device="png", width = 12, height = 8, dpi=100, units = "in")
  
```
```{r, echo=FALSE, fig.width=12, fig.height=8}
  g[["GHG_synthetic_line"]]
```

